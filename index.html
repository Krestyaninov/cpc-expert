<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор релевантности 2.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .upload-section {
            padding: 40px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .setting-block {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }
        
        .setting-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }
        
        .category-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .category-option {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .category-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .category-option.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .limit-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .slider-value {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            margin-top: 5px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 auto;
            display: block;
            text-align: center;
            width: fit-content;
        }
        
        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .preview-section {
            padding: 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: none;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .preview-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .preview-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .preview-examples {
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            padding: 40px;
            display: none;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-card.excellent { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.good { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-card.satisfactory { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-card.poor { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }
        
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .comparison-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 30px 0;
        }
        
        .comparison-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .comparison-table tr:hover {
            background: #f8f9fa;
        }
        
        .characteristics-importance {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .characteristics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .characteristic-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: help;
        }
        
        .characteristic-percentage {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }
        
        .characteristic-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .quality-rating {
            text-align: center;
            padding: 25px;
            margin: 30px 0;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .quality-excellent { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2d3748; }
        .quality-good { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2d3748; }
        .quality-satisfactory { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; }
        .quality-poor { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #2d3748; }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .example-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .example-item.good {
            border-left-color: #38a169;
        }
        
        .example-item.bad {
            border-left-color: #e53e3e;
        }
        
        .query, .title {
            margin-bottom: 8px;
        }
        
        .query {
            font-weight: 600;
            color: #2d3748;
        }
        
        .title {
            color: #4a5568;
        }
        
        .reason {
            color: #e53e3e;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #e53e3e;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #2d5a27;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #38a169;
        }

        .valve-code-info {
            background: #e6f3ff;
            border: 1px solid #4facfe;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .valve-code-match {
            background: #e6ffe6;
            border-left: 4px solid #38a169;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version-badge">Версия 2.1 (с таблицей фигур)</div>
            <h1>🔍 Анализатор релевантности заголовков</h1>
            <p>Многокатегорийный анализ с поддержкой таблицы фигур задвижек</p>
        </div>
        
        <div class="upload-section">
            <div class="settings-grid">
                <div class="setting-block">
                    <div class="setting-title">📂 Категория оборудования</div>
                    <div class="category-selector">
                        <div class="category-option active" data-category="klapany">Клапаны</div>
                        <div class="category-option" data-category="krany">Краны</div>
                        <div class="category-option" data-category="zadvijki">Задвижки</div>
                        <div class="category-option" data-category="auto">Авто</div>
                    </div>
                    <div class="valve-code-info" style="display: none;">
                        <strong>📋 Анализ таблицы фигур задвижек</strong><br>
                        При выборе категории "Задвижки" учитываются технические коды согласно ГОСТ:<br>
                        • Тип изделия (30, 31)<br>
                        • Материал корпуса (лс, с, нж, ч, бр)<br>
                        • Конструктивный номер<br>
                        • Дополнительные обозначения (ХЛ, ГАЗ, МЗВ)
                    </div>
                    <div id="craneTypeInfo" class="valve-code-info" style="display: none;">
                        <strong>🔧 Многофакторный анализ кранов</strong><br>
                        При выборе категории "Краны" анализируются:<br>
                        • Тип крана (шаровой, пробковый, игольчатый) - 4 балла<br>
                        • Конструкция (полнопроходной, трехходовой) - 2 балла<br>
                        • Управление (ручной, электропривод, пневмопривод) - 1 балл<br>
                        • Технические параметры (ДУ, РУ, материал, присоединение)
                    </div>
                </div>
                
                <div class="setting-block">
                    <div class="setting-title">📊 Лимит обработки</div>
                    <input type="range" class="limit-slider" min="100" max="10000" value="1000" step="100" id="limitSlider">
                    <div class="slider-value" id="sliderValue">1000 записей</div>
                </div>
            </div>
            
            <div class="file-input-wrapper">
                <input type="file" class="file-input" accept=".xlsx,.xls" id="fileInput">
                📁 Загрузить файл Excel
            </div>
            <p style="margin-top: 15px; text-align: center; color: #666;">Поддерживаются файлы .xlsx и .xls</p>
            
            <div id="messageArea"></div>
        </div>
        
        <div class="preview-section" id="previewSection">
            <h3 class="section-title">👀 Предпросмотр классификации</h3>
            <div class="preview-grid" id="previewGrid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="export-btn" id="startAnalysis">🚀 Начать анализ</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Анализируем данные...</p>
        </div>
        
        <div class="results" id="results">
            <div class="results-header">
                <h2>📊 Результаты анализа</h2>
                <button class="export-btn" id="exportPdf">📄 Экспорт в PDF</button>
            </div>
            
            <div class="stats-grid" id="statsGrid"></div>
            <div class="quality-rating" id="qualityRating"></div>
            
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>Тип страниц</th>
                            <th>Количество</th>
                            <th>Релевантность</th>
                            <th>Основные проблемы</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody"></tbody>
                </table>
            </div>
            
            <div class="characteristics-importance">
                <h3>🎯 Важность характеристик в запросах</h3>
                <p>Анализ всех упоминаемых технических параметров</p>
                <div class="characteristics-grid" id="characteristicsGrid"></div>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="products">Товарные страницы</button>
                <button class="tab" data-tab="listings">Страницы листинга</button>
                <button class="tab" data-tab="problems">Анализ проблем</button>
            </div>
            
            <div class="tab-content active" id="products-content"></div>
            <div class="tab-content" id="listings-content"></div>
            <div class="tab-content" id="problems-content"></div>
        </div>
    </div>

    <script>
        // ДОРАБОТАННАЯ ВЕРСИЯ С ПОДДЕРЖКОЙ ТАБЛИЦЫ ФИГУР ЗАДВИЖЕК
        
        // Конфигурация технических сокращений
        const TECHNICAL_ABBREVIATIONS = {
            'кш': 'кран шаровой',
            'кшм': 'кран шаровой муфтовый',
            'кшф': 'кран шаровой фланцевый',
            'кшт': 'кран шаровой трехходовой',
            'кшп': 'кран шаровой с пневмоприводом',
            'кшэ': 'кран шаровой с электроприводом',
            'ко': 'клапан обратный',
            'кб': 'клапан балансировочный',
            'кп': 'клапан предохранительный',
            'кр': 'клапан регулирующий',
            'зк': 'задвижка клиновая',
            'зш': 'задвижка шиберная'
        };

        // Конфигурация для расшифровки таблицы фигур задвижек
        const VALVE_CODES = {
            // Типы изделий
            types: {
                '30': 'задвижка общего назначения',
                '31': 'задвижка специальная'
            },
            // Материалы корпуса
            materials: {
                'лс': 'литая сталь',
                'с': 'сталь',
                'нж': 'нержавеющая сталь',
                'лснж': 'литая нержавеющая сталь',
                'ч': 'чугун',
                'бр': 'бронза'
            },
            // Дополнительные обозначения
            modifiers: {
                'хл': 'холодный климат',
                'газ': 'для газа',
                'мзв': 'выдвижной шпиндель',
                'мзвг': 'выдвижной шпиндель для газа'
            }
        };

        // Конфигурация категорий
        const CONFIG = {
            klapany: {
                name: 'Клапаны',
                productTypes: ['клапан', 'вентиль', 'обратный', 'балансировочный', 'предохранительный', 'регулирующий'],
                synonymGroups: [
                    ['клапан', 'вентиль'],
                    ['обратный', 'невозвратный'],
                    ['муфтовый', 'резьбовой']
                ],
                technicalCodes: ['ко', 'кб', 'кп', 'кр']
            },
            krany: {
                name: 'Краны',
                productTypes: ['кран', 'шаровой', 'пробковый', 'игольчатый'],
                synonymGroups: [
                    ['кран', 'шаровой кран'],
                    ['полнопроходной', 'полный проход'],
                    ['трехходовой', '3-х ходовой']
                ],
                technicalCodes: ['кш', 'кшм', 'кшф', 'кшт', 'кшп', 'кшэ']
            },
            zadvijki: {
                name: 'Задвижки',
                productTypes: ['задвижка', 'клиновая', 'шиберная', 'дисковая'],
                synonymGroups: [
                    ['шиберная', 'ножевая'],
                    ['выдвижной', 'выдвижной шпиндель'],
                    ['клиновая', 'клин']
                ],
                technicalCodes: ['зк', 'зш'],
                useValveCodes: true // Флаг для использования таблицы фигур
            },
            auto: {
                name: 'Авто-определение',
                productTypes: [],
                synonymGroups: [],
                technicalCodes: []
            }
        };

        let currentData = null;
        let currentConfig = CONFIG.klapany;
        let processLimit = 1000;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initializeInterface();
        });

        function initializeInterface() {
            // Настройка категорий
            document.querySelectorAll('.category-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.category-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    const category = this.dataset.category;
                    currentConfig = CONFIG[category];
                    
                    // Показать информацию о специальном анализе
                    const valveInfo = document.getElementById('valveCodeInfo');
                    const craneInfo = document.getElementById('craneTypeInfo');
                    
                    // Скрыть все информационные блоки
                    if (valveInfo) valveInfo.style.display = 'none';
                    if (craneInfo) craneInfo.style.display = 'none';
                    
                    if (category === 'zadvijki') {
                        if (valveInfo) valveInfo.style.display = 'block';
                    } else if (category === 'krany') {
                        if (craneInfo) craneInfo.style.display = 'block';
                    }
                    
                    showMessage(`Выбрана категория: ${currentConfig.name}`, 'success');
                });
            });

            // Настройка слайдера
            const slider = document.getElementById('limitSlider');
            const sliderValue = document.getElementById('sliderValue');
            
            slider.addEventListener('input', function() {
                processLimit = parseInt(this.value);
                sliderValue.textContent = `${processLimit} записей`;
            });

            // Загрузка файла
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('startAnalysis').addEventListener('click', startAnalysis);
            document.getElementById('exportPdf').addEventListener('click', exportToPdf);

            // Табы
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
        }

        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'error' ? 'error-message' : 'success-message';
            messageArea.innerHTML = `<div class="${className}">${text}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showMessage(`Загружается файл: ${file.name}`, 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('Файл не содержит листов данных');
                    }
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (!jsonData || jsonData.length < 2) {
                        throw new Error('Файл должен содержать минимум 2 строки (заголовки + данные)');
                    }
                    
                    const headers = jsonData[0];
                    if (!headers || headers.length < 4) {
                        throw new Error('Файл должен содержать минимум 4 колонки: запрос, кампания, url, title');
                    }
                    
                    currentData = jsonData;
                    showMessage(`Файл успешно загружен: ${jsonData.length - 1} записей`, 'success');
                    showPreview(jsonData);
                } catch (error) {
                    console.error('Error processing file:', error);
                    showMessage(`Ошибка при обработке файла: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('Ошибка при чтении файла', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function showPreview(data) {
            try {
                const rows = data.slice(1).filter(row => row && row[0] && row[3]);
                
                if (rows.length === 0) {
                    showMessage('В файле не найдены строки с заполненными запросами и заголовками', 'error');
                    return;
                }

                const sample = rows.slice(0, 50);
                const preview = classifyPreview(sample);
                
                const previewGrid = document.getElementById('previewGrid');
                previewGrid.innerHTML = `
                    <div class="preview-card">
                        <div class="preview-title">🛒 Товарные страницы (${preview.products.count})</div>
                        <div class="preview-examples">
                            <div style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                Страницы с подробными техническими характеристиками
                            </div>
                            ${preview.products.examples.slice(0, 3).map(ex => 
                                `<div style="margin: 8px 0; padding: 8px; background: #f0f8f0; border-radius: 4px; font-size: 0.8rem;">
                                    <strong>Запрос:</strong> ${ex.query}<br>
                                    <strong>Заголовок:</strong> ${ex.title}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="preview-card">
                        <div class="preview-title">📋 Страницы листинга (${preview.listings.count})</div>
                        <div class="preview-examples">
                            <div style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                Каталоги, категории, краткие описания
                            </div>
                            ${preview.listings.examples.slice(0, 3).map(ex => 
                                `<div style="margin: 8px 0; padding: 8px; background: #f8f0f0; border-radius: 4px; font-size: 0.8rem;">
                                    <strong>Запрос:</strong> ${ex.query}<br>
                                    <strong>Заголовок:</strong> ${ex.title}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('previewSection').style.display = 'block';
            } catch (error) {
                showMessage(`Ошибка при отображении предпросмотра: ${error.message}`, 'error');
            }
        }

        function classifyPreview(sample) {
            const classifications = {
                products: { count: 0, examples: [] },
                listings: { count: 0, examples: [] }
            };

            sample.forEach(row => {
                if (!row || !Array.isArray(row)) return;

                const query = row[0] || '';
                const url = row[2] || '';
                const title = row[3] || '';
                
                const classification = classifyPage(url, title);
                classifications[classification].count++;
                
                if (classifications[classification].examples.length < 5) {
                    classifications[classification].examples.push({
                        query: query.length > 60 ? query.substring(0, 60) + '...' : query,
                        title: title.length > 80 ? title.substring(0, 80) + '...' : title
                    });
                }
            });

            return classifications;
        }

        function classifyPage(url, title) {
            const titleLower = title.toLowerCase();
            
            const hasDetailedSpecs = /ду\s*\d+|dn\s*\d+|ру\s*\d+|pn\s*\d+|\d+\s*мм|\d+"|1\/2|3\/4/i.test(title);
            const hasModelNumber = /[A-Z0-9]{2,}[-\(\)A-Z0-9]*\d/i.test(title);
            const hasDetailedDescription = title.length > 50;
            const hasTechnicalTerms = /(нержавеющая|латунь|чугун|полнопроходной|фланцевый|муфтовый|резьбовой|привод|рычаг)/i.test(title);
            
            const isCatalogPage = /(каталог|категория|все|подбор|выбор|серия|линейка)/i.test(title);
            const isBrandPage = /^[A-Z\s]+$/i.test(title.trim()) && title.length < 30;
            const isGenericTitle = title.length < 30 && !hasDetailedSpecs;
            
            if (isCatalogPage || isBrandPage || isGenericTitle) {
                return 'listings';
            }
            
            if (hasDetailedSpecs && (hasModelNumber || hasTechnicalTerms) && hasDetailedDescription) {
                return 'products';
            }
            
            return 'listings';
        }

        function startAnalysis() {
            if (!currentData) {
                showMessage('Данные не загружены', 'error');
                return;
            }

            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            setTimeout(() => {
                try {
                    analyzeData(currentData);
                } catch (error) {
                    console.error('Error in analysis:', error);
                    document.getElementById('loading').style.display = 'none';
                    showMessage(`Ошибка при анализе: ${error.message}`, 'error');
                }
            }, 500);
        }

        function analyzeData(data) {
            try {
                const rows = data.slice(1).filter(row => row && row[0] && row[3]);
                const sampleSize = Math.min(rows.length, processLimit);
                const sample = rows.slice(0, sampleSize);

                const characteristicsAnalysis = analyzeCharacteristics(sample);

                const results = {
                    total: sampleSize,
                    products: [],
                    listings: [],
                    characteristics: characteristicsAnalysis
                };

                sample.forEach(row => {
                    const query = row[0] || '';
                    const url = row[2] || '';
                    const title = row[3] || '';
                    
                    const classification = classifyPage(url, title);
                    const relevanceResult = analyzeRelevance(query, title, classification);
                    
                    results[classification].push({
                        query,
                        url,
                        title,
                        relevance: relevanceResult
                    });
                });

                displayResults(results);
            } catch (error) {
                console.error('Error in analyzeData:', error);
                document.getElementById('loading').style.display = 'none';
                showMessage(`Ошибка анализа данных: ${error.message}`, 'error');
            }
        }

        // НОВАЯ ФУНКЦИЯ: Парсинг технического кода задвижки
        function parseValveCode(text) {
            // Удаляем все в скобках и лишние пробелы
            const cleanText = text.replace(/\([^)]*\)/g, '').trim().toLowerCase();
            
            // Ищем паттерн: цифры + буквы + цифры + возможные дополнения
            const valvePattern = /(\d{2,3})([а-я]+)(\d+)([а-я]*)/g;
            const matches = [...cleanText.matchAll(valvePattern)];
            
            const codes = [];
            
            matches.forEach(match => {
                const [fullMatch, typeCode, materialCode, constructiveNumber, modifiers] = match;
                
                const parsed = {
                    original: fullMatch,
                    type: typeCode,
                    material: materialCode,
                    constructiveNumber: constructiveNumber,
                    modifiers: modifiers || '',
                    normalized: `${typeCode}${materialCode}${constructiveNumber}${modifiers}`
                };
                
                codes.push(parsed);
            });
            
            return codes;
        }

        // НОВАЯ ФУНКЦИЯ: Сравнение технических кодов задвижек
        function compareValveCodes(queryCode, titleCode) {
            const queryParsed = parseValveCode(queryCode);
            const titleParsed = parseValveCode(titleCode);
            
            if (queryParsed.length === 0 || titleParsed.length === 0) {
                return { match: false, details: 'Не найдены технические коды' };
            }
            
            // Ищем совпадения между любыми найденными кодами
            for (let qCode of queryParsed) {
                for (let tCode of titleParsed) {
                    // Проверяем точное совпадение нормализованного кода
                    if (qCode.normalized === tCode.normalized) {
                        return {
                            match: true,
                            details: `Точное совпадение: ${qCode.original}`,
                            queryCode: qCode,
                            titleCode: tCode
                        };
                    }
                    
                    // Проверяем совпадение основных параметров (тип + материал + конструктив)
                    if (qCode.type === tCode.type && 
                        qCode.material === tCode.material && 
                        qCode.constructiveNumber === tCode.constructiveNumber) {
                        return {
                            match: true,
                            details: `Совпадение основных параметров: ${qCode.type}${qCode.material}${qCode.constructiveNumber}`,
                            queryCode: qCode,
                            titleCode: tCode
                        };
                    }
                }
            }
            
            return {
                match: false,
                details: `Несовпадение кодов: запрос ${queryParsed.map(c => c.original).join(', ')}, заголовок ${titleParsed.map(c => c.original).join(', ')}`,
                queryParsed,
                titleParsed
            };
        }

        function analyzeCharacteristics(sample) {
            const characteristics = {};
            
            let patterns = [
                { pattern: /ду\s*(\d+)/gi, name: 'Диаметр ДУ', category: 'size' },
                { pattern: /dn\s*(\d+)/gi, name: 'Диаметр DN', category: 'size' },
                { pattern: /ру\s*(\d+)/gi, name: 'Давление РУ', category: 'pressure' },
                { pattern: /pn\s*(\d+)/gi, name: 'Давление PN', category: 'pressure' },
                { pattern: /(\d+)\s*мм/gi, name: 'Размер в мм', category: 'size' },
                { pattern: /латун/gi, name: 'Латунь', category: 'material' },
                { pattern: /нержав/gi, name: 'Нержавеющая сталь', category: 'material' },
                { pattern: /муфтов/gi, name: 'Муфтовое соединение', category: 'connection' },
                { pattern: /фланц/gi, name: 'Фланцевое соединение', category: 'connection' }
            ];

            // Добавляем специальные паттерны для задвижек
            if (currentConfig.useValveCodes) {
                patterns.push(
                    { pattern: /30[а-я]+\d+/gi, name: 'Код задвижки тип 30', category: 'valve_code' },
                    { pattern: /31[а-я]+\d+/gi, name: 'Код задвижки тип 31', category: 'valve_code' },
                    { pattern: /клинов/gi, name: 'Клиновая задвижка', category: 'valve_type' },
                    { pattern: /шибер/gi, name: 'Шиберная задвижка', category: 'valve_type' }
                );
            }

            // Добавляем специальные паттерны для кранов
            if (currentConfig.name === 'Краны') {
                patterns.push(
                    { pattern: /шаров/gi, name: 'Шаровой кран', category: 'crane_type' },
                    { pattern: /полнопроходн/gi, name: 'Полнопроходной', category: 'crane_design' },
                    { pattern: /трехходов/gi, name: 'Трехходовой', category: 'crane_design' },
                    { pattern: /электропривод/gi, name: 'Электропривод', category: 'crane_control' },
                    { pattern: /пневмопривод/gi, name: 'Пневмопривод', category: 'crane_control' },
                    { pattern: /рычаг/gi, name: 'Ручной (рычаг)', category: 'crane_control' }
                );
            }
            
            sample.forEach(row => {
                if (!row || !row[0]) return;
                
                const query = row[0].toLowerCase();
                
                patterns.forEach(({ pattern, name, category }) => {
                    const regex = new RegExp(pattern.source, pattern.flags);
                    if (regex.test(query)) {
                        const key = `${category}_${name}`;
                        if (!characteristics[key]) {
                            characteristics[key] = {
                                name: name,
                                category: category,
                                count: 0,
                                total: sample.length
                            };
                        }
                        characteristics[key].count++;
                    }
                });
            });

            Object.keys(characteristics).forEach(key => {
                characteristics[key].percentage = Math.round(
                    (characteristics[key].count / characteristics[key].total) * 100
                );
            });

            return characteristics;
        }

        // НОВАЯ ФУНКЦИЯ: Извлечение типов кранов
        function extractValveTypes(text) {
            const types = [];
            const textLower = text.toLowerCase();
            
            // Основные типы кранов
            if (/шаров/i.test(text)) types.push('шаровой');
            if (/пробков/i.test(text)) types.push('пробковый');
            if (/игольчат/i.test(text)) types.push('игольчатый');
            if (/газов/i.test(text)) types.push('газовый');
            
            // Конструктивные особенности
            if (/полнопроходн/i.test(text) || /полный проход/i.test(text)) types.push('полнопроходной');
            if (/стандартнопроходн/i.test(text) || /стандартный проход/i.test(text)) types.push('стандартнопроходной');
            if (/трехходов/i.test(text) || /3-?х?\s*ходов/i.test(text)) types.push('трехходовой');
            if (/четырехходов/i.test(text) || /4-?х?\s*ходов/i.test(text)) types.push('четырехходовой');
            
            // Типы управления
            if (/ручн/i.test(text) || /штурвал/i.test(text) || /рычаг/i.test(text)) types.push('ручной');
            if (/электропривод/i.test(text) || /электро/i.test(text)) types.push('с электроприводом');
            if (/пневмопривод/i.test(text) || /пневмо/i.test(text)) types.push('с пневмоприводом');
            
            return [...new Set(types)];
        }

        // НОВАЯ ФУНКЦИЯ: Сравнение типов кранов
        function compareValveTypes(queryTypes, titleTypes) {
            const compatibility = {
                score: 0,
                maxScore: 0,
                details: []
            };

            if (queryTypes.length === 0) return compatibility;

            // Основные типы кранов (высокий вес: 4 балла)
            const mainTypes = ['шаровой', 'пробковый', 'игольчатый', 'газовый'];
            const queryMainTypes = queryTypes.filter(t => mainTypes.includes(t));
            const titleMainTypes = titleTypes.filter(t => mainTypes.includes(t));
            
            if (queryMainTypes.length > 0) {
                compatibility.maxScore += 4;
                const mainTypeMatch = queryMainTypes.some(qt => titleMainTypes.includes(qt));
                if (mainTypeMatch) {
                    compatibility.score += 4;
                    compatibility.details.push(`✅ Тип крана: ${queryMainTypes.join(', ')} совпадает с ${titleMainTypes.join(', ')}`);
                } else if (titleMainTypes.length > 0) {
                    compatibility.details.push(`❌ Тип крана: ${queryMainTypes.join(', ')} ≠ ${titleMainTypes.join(', ')}`);
                }
            }

            // Конструктивные особенности (средний вес: 2 балла)
            const designTypes = ['полнопроходной', 'стандартнопроходной', 'трехходовой', 'четырехходовой'];
            const queryDesignTypes = queryTypes.filter(t => designTypes.includes(t));
            const titleDesignTypes = titleTypes.filter(t => designTypes.includes(t));
            
            if (queryDesignTypes.length > 0) {
                compatibility.maxScore += 2;
                const designMatch = queryDesignTypes.some(qt => titleDesignTypes.includes(qt));
                if (designMatch) {
                    compatibility.score += 2;
                    compatibility.details.push(`✅ Конструкция: ${queryDesignTypes.join(', ')} совпадает`);
                } else if (titleDesignTypes.length > 0) {
                    compatibility.details.push(`❌ Конструкция: ${queryDesignTypes.join(', ')} ≠ ${titleDesignTypes.join(', ')}`);
                }
            }

            // Типы управления (низкий вес: 1 балл)
            const controlTypes = ['ручной', 'с электроприводом', 'с пневмоприводом'];
            const queryControlTypes = queryTypes.filter(t => controlTypes.includes(t));
            const titleControlTypes = titleTypes.filter(t => controlTypes.includes(t));
            
            if (queryControlTypes.length > 0) {
                compatibility.maxScore += 1;
                const controlMatch = queryControlTypes.some(qt => titleControlTypes.includes(qt));
                if (controlMatch) {
                    compatibility.score += 1;
                    compatibility.details.push(`✅ Управление: ${queryControlTypes.join(', ')} совпадает`);
                } else if (titleControlTypes.length > 0) {
                    compatibility.details.push(`❌ Управление: ${queryControlTypes.join(', ')} ≠ ${titleControlTypes.join(', ')}`);
                }
            }

            return compatibility;
        }

        // НОВАЯ ФУНКЦИЯ: Анализ релевантности для кранов
        function analyzeCraneRelevance(query, title, pageType) {
            const queryLower = query.toLowerCase();
            const titleLower = title.toLowerCase();
            
            // Проверяем наличие слова "кран" в запросе или заголовке
            const hasCraneInQuery = /кран/i.test(query);
            const hasCraneInTitle = /кран/i.test(title);
            
            if (!hasCraneInQuery && !hasCraneInTitle) {
                return { relevant: false, reason: 'Не найдено упоминание "кран"' };
            }

            // 1. Извлекаем технические параметры
            const queryParams = extractTechnicalParams(query);
            const titleParams = extractTechnicalParams(title);
            const paramCompatibility = compareTechnicalParams(queryParams, titleParams);

            // 2. Извлекаем и сравниваем типы кранов
            const queryTypes = extractValveTypes(query);
            const titleTypes = extractValveTypes(title);
            const typeCompatibility = compareValveTypes(queryTypes, titleTypes);

            // 3. Объединяем оценки параметров и типов
            const totalScore = paramCompatibility.score + typeCompatibility.score;
            const totalMaxScore = paramCompatibility.maxScore + typeCompatibility.maxScore;
            const allDetails = [...paramCompatibility.details, ...typeCompatibility.details];

            // 4. Логика принятия решения
            if (totalMaxScore === 0) {
                // Нет параметров для сравнения - базовая проверка
                const queryInfo = extractInfo(query);
                const titleInfo = extractInfo(title);
                
                if (queryInfo.types.length > 0 && titleInfo.types.length > 0) {
                    if (areTypesCompatible(queryInfo.types, titleInfo.types)) {
                        return { 
                            relevant: true, 
                            reason: 'Соответствие базовых типов кранов',
                            paramDetails: { score: 0, maxScore: 0, details: allDetails },
                            typeDetails: typeCompatibility
                        };
                    }
                }
                
                if (hasCraneInQuery && hasCraneInTitle) {
                    return { 
                        relevant: true, 
                        reason: 'Минимальное соответствие: упоминание крана без детальных параметров',
                        paramDetails: paramCompatibility,
                        typeDetails: typeCompatibility
                    };
                }
                
                return { 
                    relevant: false, 
                    reason: 'Недостаточно данных для анализа соответствия',
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            }

            const compatibilityPercent = (totalScore / totalMaxScore) * 100;
            
            if (compatibilityPercent >= 90) {
                return { 
                    relevant: true, 
                    reason: `Отличное соответствие (${totalScore}/${totalMaxScore} - ${compatibilityPercent.toFixed(1)}%)`,
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            } else if (compatibilityPercent >= 70) {
                return { 
                    relevant: true, 
                    reason: `Хорошее соответствие (${totalScore}/${totalMaxScore} - ${compatibilityPercent.toFixed(1)}%)`,
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            } else if (compatibilityPercent >= 50) {
                return { 
                    relevant: true, 
                    reason: `Частичное соответствие (${totalScore}/${totalMaxScore} - ${compatibilityPercent.toFixed(1)}%)`,
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            } else {
                return { 
                    relevant: false, 
                    reason: `Низкое соответствие (${totalScore}/${totalMaxScore} - ${compatibilityPercent.toFixed(1)}%)`,
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            }
        }

        // ОБНОВЛЕННАЯ ФУНКЦИЯ: Анализ релевантности с поддержкой всех категорий
        function analyzeRelevance(query, title, pageType) {
            // Специальная логика для задвижек
            if (currentConfig.useValveCodes) {
                return analyzeValveRelevance(query, title, pageType);
            }
            
            // Специальная логика для кранов
            if (currentConfig.name === 'Краны') {
                return analyzeCraneRelevance(query, title, pageType);
            }
            
            // Стандартная логика для клапанов и других категорий
            const queryInfo = extractInfo(query);
            const titleInfo = extractInfo(title);
            
            if (queryInfo.types.length === 0) {
                return { relevant: false, reason: 'Не определен тип товара в запросе' };
            }
            
            if (titleInfo.types.length === 0) {
                return { relevant: false, reason: 'Не определен тип товара в заголовке' };
            }
            
            if (!areTypesCompatible(queryInfo.types, titleInfo.types)) {
                return { relevant: false, reason: 'Несоответствие типа товара' };
            }
            
            return { relevant: true, reason: 'Соответствует критериям' };
        }

        // НОВАЯ ФУНКЦИЯ: Извлечение технических параметров
        function extractTechnicalParams(text) {
            const params = {
                diameters: [],
                pressures: [],
                materials: [],
                connections: [],
                temperatures: []
            };

            // Диаметры
            const duMatches = [...text.matchAll(/ду\s*(\d+)/gi)];
            const dnMatches = [...text.matchAll(/dn\s*(\d+)/gi)];
            params.diameters = [...duMatches, ...dnMatches].map(m => parseInt(m[1]));

            // Давления
            const ruMatches = [...text.matchAll(/ру\s*(\d+)/gi)];
            const pnMatches = [...text.matchAll(/pn\s*(\d+)/gi)];
            params.pressures = [...ruMatches, ...pnMatches].map(m => parseInt(m[1]));

            // Материалы
            if (/нержав/i.test(text)) params.materials.push('нержавеющая');
            if (/латун/i.test(text)) params.materials.push('латунь');
            if (/чугун/i.test(text)) params.materials.push('чугун');
            if (/сталь/i.test(text) && !/нержав/i.test(text)) params.materials.push('сталь');

            // Присоединения
            if (/фланц/i.test(text)) params.connections.push('фланцевое');
            if (/муфтов/i.test(text)) params.connections.push('муфтовое');
            if (/резьбов/i.test(text)) params.connections.push('резьбовое');

            return params;
        }

        // НОВАЯ ФУНКЦИЯ: Сравнение технических параметров
        function compareTechnicalParams(queryParams, titleParams) {
            const compatibility = {
                score: 0,
                maxScore: 0,
                details: []
            };

            // Сравнение диаметров (вес: 3 балла)
            if (queryParams.diameters.length > 0) {
                compatibility.maxScore += 3;
                const diameterMatch = queryParams.diameters.some(qd => 
                    titleParams.diameters.some(td => Math.abs(qd - td) <= 5) // ±5мм допуск
                );
                if (diameterMatch) {
                    compatibility.score += 3;
                    compatibility.details.push(`✅ Диаметр: ${queryParams.diameters.join(', ')} ≈ ${titleParams.diameters.join(', ')}`);
                } else if (titleParams.diameters.length > 0) {
                    compatibility.details.push(`❌ Диаметр: ${queryParams.diameters.join(', ')} ≠ ${titleParams.diameters.join(', ')}`);
                }
            }

            // Сравнение давлений (вес: 2 балла)
            if (queryParams.pressures.length > 0) {
                compatibility.maxScore += 2;
                const pressureMatch = queryParams.pressures.some(qp => 
                    titleParams.pressures.some(tp => qp === tp)
                );
                if (pressureMatch) {
                    compatibility.score += 2;
                    compatibility.details.push(`✅ Давление: ${queryParams.pressures.join(', ')} = ${titleParams.pressures.join(', ')}`);
                } else if (titleParams.pressures.length > 0) {
                    compatibility.details.push(`❌ Давление: ${queryParams.pressures.join(', ')} ≠ ${titleParams.pressures.join(', ')}`);
                }
            }

            // Сравнение материалов (вес: 2 балла)
            if (queryParams.materials.length > 0) {
                compatibility.maxScore += 2;
                const materialMatch = queryParams.materials.some(qm => 
                    titleParams.materials.includes(qm)
                );
                if (materialMatch) {
                    compatibility.score += 2;
                    compatibility.details.push(`✅ Материал: совпадение (${queryParams.materials.join(', ')})`);
                } else if (titleParams.materials.length > 0) {
                    compatibility.details.push(`❌ Материал: ${queryParams.materials.join(', ')} ≠ ${titleParams.materials.join(', ')}`);
                }
            }

            // Сравнение присоединений (вес: 1 балл)
            if (queryParams.connections.length > 0) {
                compatibility.maxScore += 1;
                const connectionMatch = queryParams.connections.some(qc => 
                    titleParams.connections.includes(qc)
                );
                if (connectionMatch) {
                    compatibility.score += 1;
                    compatibility.details.push(`✅ Присоединение: совпадение (${queryParams.connections.join(', ')})`);
                } else if (titleParams.connections.length > 0) {
                    compatibility.details.push(`❌ Присоединение: ${queryParams.connections.join(', ')} ≠ ${titleParams.connections.join(', ')}`);
                }
            }

            return compatibility;
        }

        // ОБНОВЛЕННАЯ ФУНКЦИЯ: Анализ релевантности для задвижек
        function analyzeValveRelevance(query, title, pageType) {
            const queryLower = query.toLowerCase();
            const titleLower = title.toLowerCase();
            
            // Проверяем наличие слова "задвижка" в запросе или заголовке
            const hasValveInQuery = /задвижк/i.test(query);
            const hasValveInTitle = /задвижк/i.test(title);
            
            if (!hasValveInQuery && !hasValveInTitle) {
                return { relevant: false, reason: 'Не найдено упоминание "задвижка"' };
            }
            
            // 1. Проверяем технические коды (высший приоритет)
            const codeComparison = compareValveCodes(query, title);
            
            // 2. Проверяем технические параметры
            const queryParams = extractTechnicalParams(query);
            const titleParams = extractTechnicalParams(title);
            const paramCompatibility = compareTechnicalParams(queryParams, titleParams);
            
            // 3. Логика принятия решения
            if (codeComparison.match) {
                // Есть совпадение кодов - проверяем параметры для уточнения
                if (paramCompatibility.maxScore > 0 && paramCompatibility.score === paramCompatibility.maxScore) {
                    return { 
                        relevant: true, 
                        reason: `Полное соответствие: коды + параметры (${paramCompatibility.score}/${paramCompatibility.maxScore})`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                } else {
                    return { 
                        relevant: true, 
                        reason: `Совпадение кодов: ${codeComparison.details}`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                }
            }
            
            // 4. Если кодов нет, оцениваем по параметрам
            if (paramCompatibility.maxScore > 0) {
                const compatibilityPercent = (paramCompatibility.score / paramCompatibility.maxScore) * 100;
                
                if (compatibilityPercent >= 80) {
                    return { 
                        relevant: true, 
                        reason: `Высокое соответствие параметров (${paramCompatibility.score}/${paramCompatibility.maxScore})`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                } else if (compatibilityPercent >= 50) {
                    return { 
                        relevant: true, 
                        reason: `Частичное соответствие параметров (${paramCompatibility.score}/${paramCompatibility.maxScore})`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                } else {
                    return { 
                        relevant: false, 
                        reason: `Низкое соответствие параметров (${paramCompatibility.score}/${paramCompatibility.maxScore})`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                }
            }
            
            // 5. Проверяем совпадение типов арматуры
            const queryInfo = extractInfo(query);
            const titleInfo = extractInfo(title);
            
            if (queryInfo.types.length > 0 && titleInfo.types.length > 0) {
                if (areTypesCompatible(queryInfo.types, titleInfo.types)) {
                    return { 
                        relevant: true, 
                        reason: 'Совпадение типов задвижек',
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                }
            }
            
            // 6. Минимальное соответствие - только упоминание задвижки
            if (hasValveInQuery && hasValveInTitle) {
                return { 
                    relevant: true, 
                    reason: 'Минимальное соответствие: упоминание задвижки без детальных параметров',
                    codeDetails: codeComparison,
                    paramDetails: paramCompatibility
                };
            }
            
            return { 
                relevant: false, 
                reason: `Несоответствие: ${codeComparison.details}`,
                codeDetails: codeComparison,
                paramDetails: paramCompatibility
            };
        }

        function extractInfo(text) {
            const normalized = text.toLowerCase().replace(/[^\wа-я]/g, ' ').replace(/\s+/g, ' ').trim();
            let foundTypes = [];
            
            for (let [code, expansion] of Object.entries(TECHNICAL_ABBREVIATIONS)) {
                if (normalized.includes(code)) {
                    foundTypes.push(...expansion.split(' '));
                }
            }
            
            if (currentConfig.productTypes) {
                for (let type of currentConfig.productTypes) {
                    if (normalized.includes(type)) {
                        foundTypes.push(type);
                    }
                }
            }
            
            return { types: [...new Set(foundTypes)] };
        }

        function areTypesCompatible(queryTypes, titleTypes) {
            if (!queryTypes.length || !titleTypes.length) return false;
            
            for (let qType of queryTypes) {
                if (titleTypes.includes(qType)) return true;
            }
            
            if (currentConfig.synonymGroups) {
                for (let group of currentConfig.synonymGroups) {
                    let queryHas = queryTypes.some(t => group.includes(t));
                    let titleHas = titleTypes.some(t => group.includes(t));
                    if (queryHas && titleHas) return true;
                }
            }
            
            return false;
        }

        function calculateOverallStats(results) {
            const productRelevant = results.products.filter(item => item.relevance.relevant).length;
            const listingRelevant = results.listings.filter(item => item.relevance.relevant).length;
            
            const weightedTotal = results.products.length * 1.0 + results.listings.length * 0.5;
            const weightedRelevant = productRelevant * 1.0 + listingRelevant * 0.5;
            const overallPercentage = weightedTotal > 0 ? (weightedRelevant / weightedTotal * 100).toFixed(1) : 0;

            return {
                total: results.total,
                products: results.products.length,
                listings: results.listings.length,
                overallPercentage: overallPercentage
            };
        }

        function calculateStats(pageData) {
            if (!pageData || !Array.isArray(pageData)) {
                return { total: 0, relevant: 0, irrelevant: 0, percentage: 0, problems: {} };
            }

            const total = pageData.length;
            const relevant = pageData.filter(item => item.relevance && item.relevance.relevant).length;
            const percentage = total > 0 ? (relevant / total * 100).toFixed(1) : 0;
            
            const problems = {};
            pageData.filter(item => item.relevance && !item.relevance.relevant).forEach(item => {
                const reason = item.relevance.reason || 'Неизвестная причина';
                problems[reason] = (problems[reason] || 0) + 1;
            });

            return { total, relevant, irrelevant: total - relevant, percentage, problems };
        }

        function displayResults(results) {
            try {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';

                const productStats = calculateStats(results.products);
                const listingStats = calculateStats(results.listings);
                const overallStats = calculateOverallStats(results);

                displayOverallStats(overallStats);
                displayComparisonTable(productStats, listingStats);
                displayCharacteristicsImportance(results.characteristics);
                displayTabContent(results, productStats, listingStats);

                showMessage('Анализ завершен успешно!', 'success');
            } catch (error) {
                console.error('Error in displayResults:', error);
                showMessage(`Ошибка при отображении результатов: ${error.message}`, 'error');
            }
        }

        function displayOverallStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card excellent">
                    <span class="stat-value">${stats.total}</span>
                    <div class="stat-label">Всего записей</div>
                </div>
                <div class="stat-card good">
                    <span class="stat-value">${stats.products}</span>
                    <div class="stat-label">Товарные страницы</div>
                </div>
                <div class="stat-card satisfactory">
                    <span class="stat-value">${stats.listings}</span>
                    <div class="stat-label">Страницы листинга</div>
                </div>
                <div class="stat-card poor">
                    <span class="stat-value">${stats.overallPercentage}%</span>
                    <div class="stat-label">Общая релевантность</div>
                </div>
            `;

            const qualityRating = document.getElementById('qualityRating');
            const percentage = parseFloat(stats.overallPercentage);
            let qualityClass, qualityText;
            
            if (percentage >= 90) {
                qualityClass = 'quality-excellent';
                qualityText = '🟢 ОТЛИЧНО';
            } else if (percentage >= 80) {
                qualityClass = 'quality-good';
                qualityText = '🟡 ХОРОШО';
            } else if (percentage >= 70) {
                qualityClass = 'quality-satisfactory';
                qualityText = '🟠 УДОВЛЕТВОРИТЕЛЬНО';
            } else {
                qualityClass = 'quality-poor';
                qualityText = '🔴 ТРЕБУЕТ ИСПРАВЛЕНИЯ';
            }
            
            qualityRating.className = `quality-rating ${qualityClass}`;
            qualityRating.innerHTML = `${qualityText}<br><span style="font-size: 1.2rem;">Общая релевантность: ${stats.overallPercentage}%</span>`;
        }

        function displayComparisonTable(productStats, listingStats) {
            const comparisonBody = document.getElementById('comparisonBody');
            
            const getTopProblems = (problems) => {
                if (!problems || typeof problems !== 'object') return 'Нет проблем';
                const sorted = Object.entries(problems).sort((a, b) => b[1] - a[1]);
                return sorted.slice(0, 2).map(([problem, count]) => `${problem} (${count})`).join(', ') || 'Нет проблем';
            };

            comparisonBody.innerHTML = `
                <tr>
                    <td><strong>Товарные страницы</strong></td>
                    <td>${productStats.total}</td>
                    <td><span style="color: ${productStats.percentage >= 80 ? '#38a169' : '#e53e3e'}">${productStats.percentage}%</span></td>
                    <td>${getTopProblems(productStats.problems)}</td>
                </tr>
                <tr>
                    <td><strong>Страницы листинга</strong></td>
                    <td>${listingStats.total}</td>
                    <td><span style="color: ${listingStats.percentage >= 70 ? '#38a169' : '#e53e3e'}">${listingStats.percentage}%</span></td>
                    <td>${getTopProblems(listingStats.problems)}</td>
                </tr>
            `;
        }

        function displayCharacteristicsImportance(characteristics) {
            const characteristicsGrid = document.getElementById('characteristicsGrid');
            
            const filteredChars = Object.entries(characteristics)
                .filter(([key, data]) => data.percentage >= 1)
                .sort((a, b) => b[1].percentage - a[1].percentage)
                .slice(0, 12);

            if (filteredChars.length === 0) {
                characteristicsGrid.innerHTML = '<p style="text-align: center; opacity: 0.7;">Характеристики не найдены</p>';
                return;
            }

            characteristicsGrid.innerHTML = filteredChars.map(([key, data]) => `
                <div class="characteristic-item">
                    <span class="characteristic-percentage">${data.percentage}%</span>
                    <div class="characteristic-label">${data.name}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">${data.count}/${data.total}</div>
                </div>
            `).join('');
        }

        // ОБНОВЛЕННАЯ ФУНКЦИЯ: Отображение примеров с полным анализом параметров
        function displayTabContent(results, productStats, listingStats) {
            const productsContent = document.getElementById('products-content');
            const productExamples = getExamples(results.products, 5);
            
            productsContent.innerHTML = `
                <h3 class="section-title">✅ Примеры хороших соответствий (${productExamples.good.length})</h3>
                ${productExamples.good.map(example => `
                    <div class="example-item good">
                        <div class="query"><strong>Запрос:</strong> ${example.query}</div>
                        <div class="title"><strong>Заголовок:</strong> ${example.title}</div>
                        <div class="reason" style="color: #38a169;"><strong>✅ Причина релевантности:</strong> ${example.relevance.reason}</div>
                        ${example.relevance.codeDetails ? `
                            <div class="valve-code-match">
                                <strong>🔧 Анализ технических кодов:</strong> ${example.relevance.codeDetails.details}
                            </div>
                        ` : ''}
                        ${example.relevance.paramDetails && example.relevance.paramDetails.details.length > 0 ? `
                            <div class="valve-code-match" style="background: #f0f8ff; border-left-color: #4facfe;">
                                <strong>📊 Технические параметры (${example.relevance.paramDetails.score}/${example.relevance.paramDetails.maxScore}):</strong><br>
                                ${example.relevance.paramDetails.details.join('<br>')}
                            </div>
                        ` : ''}
                        ${example.relevance.typeDetails && example.relevance.typeDetails.details.length > 0 ? `
                            <div class="valve-code-match" style="background: #f0fff0; border-left-color: #38a169;">
                                <strong>🔧 Типы и конструкция (${example.relevance.typeDetails.score}/${example.relevance.typeDetails.maxScore}):</strong><br>
                                ${example.relevance.typeDetails.details.join('<br>')}
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
                
                <h3 class="section-title">❌ Примеры проблемных случаев (${productExamples.bad.length})</h3>
                ${productExamples.bad.map(example => `
                    <div class="example-item bad">
                        <div class="query"><strong>Запрос:</strong> ${example.query}</div>
                        <div class="title"><strong>Заголовок:</strong> ${example.title}</div>
                        <div class="reason"><strong>❌ Проблема:</strong> ${example.relevance.reason}</div>
                        ${example.relevance.codeDetails ? `
                            <div style="font-size: 0.85rem; margin-top: 8px; color: #666;">
                                <strong>🔧 Анализ кодов:</strong> ${example.relevance.codeDetails.details}
                            </div>
                        ` : ''}
                        ${example.relevance.paramDetails && example.relevance.paramDetails.details.length > 0 ? `
                            <div style="font-size: 0.85rem; margin-top: 8px; color: #666;">
                                <strong>📊 Технические параметры (${example.relevance.paramDetails.score}/${example.relevance.paramDetails.maxScore}):</strong><br>
                                ${example.relevance.paramDetails.details.join('<br>')}
                            </div>
                        ` : ''}
                        ${example.relevance.typeDetails && example.relevance.typeDetails.details.length > 0 ? `
                            <div style="font-size: 0.85rem; margin-top: 8px; color: #666;">
                                <strong>🔧 Типы и конструкция (${example.relevance.typeDetails.score}/${example.relevance.typeDetails.maxScore}):</strong><br>
                                ${example.relevance.typeDetails.details.join('<br>')}
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;

            const listingsContent = document.getElementById('listings-content');
            const listingExamples = getExamples(results.listings, 5);
            
            listingsContent.innerHTML = `
                <p style="margin-bottom: 20px; color: #666;">Страницы каталогов, категорий и кратких описаний (вес 50%)</p>
                
                <h3 class="section-title">✅ Примеры хороших соответствий (${listingExamples.good.length})</h3>
                ${listingExamples.good.map(example => `
                    <div class="example-item good">
                        <div class="query"><strong>Запрос:</strong> ${example.query}</div>
                        <div class="title"><strong>Заголовок:</strong> ${example.title}</div>
                        <div class="reason" style="color: #38a169;"><strong>✅ Причина релевантности:</strong> ${example.relevance.reason}</div>
                    </div>
                `).join('')}
                
                <h3 class="section-title">❌ Примеры проблемных случаев (${listingExamples.bad.length})</h3>
                ${listingExamples.bad.map(example => `
                    <div class="example-item bad">
                        <div class="query"><strong>Запрос:</strong> ${example.query}</div>
                        <div class="title"><strong>Заголовок:</strong> ${example.title}</div>
                        <div class="reason"><strong>❌ Проблема:</strong> ${example.relevance.reason}</div>
                    </div>
                `).join('')}
            `;

            const problemsContent = document.getElementById('problems-content');
            const allProblems = { ...productStats.problems, ...listingStats.problems };
            
            problemsContent.innerHTML = `
                <h3 class="section-title">🔍 Основные типы проблем</h3>
                ${Object.entries(allProblems).sort((a, b) => b[1] - a[1]).map(([problem, count]) => `
                    <div class="example-item">
                        <div class="query"><strong>Проблема:</strong> ${problem}</div>
                        <div class="title"><strong>Количество случаев:</strong> ${count}</div>
                        <div style="color: #666; margin-top: 10px;">
                            <strong>💡 Рекомендация:</strong> ${getProblemSolution(problem)}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getProblemSolution(problem) {
            const solutions = {
                'Не определен тип товара в запросе': 'Рекомендуется расширить семантическое ядро с конкретными типами товаров',
                'Не определен тип товара в заголовке': 'Необходимо дополнить заголовки конкретными названиями товаров',
                'Несоответствие типа товара': 'Проверьте соответствие landing page запросам пользователей',
                'Не найдено упоминание "задвижка"': 'Добавьте термин "задвижка" в заголовки или убедитесь в корректности классификации',
                'Не найдено упоминание "кран"': 'Добавьте термин "кран" в заголовки или убедитесь в корректности классификации',
                'Несоответствие технических кодов': 'Проверьте соответствие технических кодов задвижек в запросах и заголовках согласно ГОСТ',
                'Низкое соответствие параметров': 'Убедитесь в соответствии диаметров, давлений и материалов между запросом и заголовком',
                'Низкое соответствие': 'Улучшите соответствие технических характеристик и типов арматуры',
                'Частичное соответствие': 'Добавьте дополнительные технические характеристики для повышения релевантности',
                'Минимальное соответствие': 'Добавьте технические характеристики (ДУ, РУ, материал, тип) в заголовки для повышения релевантности',
                'Недостаточно данных для анализа соответствия': 'Добавьте технические параметры и характеристики в запросы и заголовки'
            };
            return solutions[problem] || 'Требуется индивидуальный анализ';
        }

        function getExamples(data, limit) {
            if (!data || !Array.isArray(data)) {
                return { good: [], bad: [] };
            }

            const good = data.filter(item => item.relevance && item.relevance.relevant).slice(0, limit);
            const bad = data.filter(item => item.relevance && !item.relevance.relevant).slice(0, limit);
            return { good, bad };
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        function exportToPdf() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('Анализ релевантности заголовков', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Категория: ${currentConfig.name}`, 20, 50);
                doc.text(`Дата анализа: ${new Date().toLocaleDateString('ru-RU')}`, 20, 60);
                
                if (currentConfig.useValveCodes) {
                    doc.text('Использована таблица фигур задвижек', 20, 70);
                }
                
                const qualityElement = document.getElementById('qualityRating');
                if (qualityElement) {
                    const qualityText = qualityElement.textContent.replace(/\s+/g, ' ').trim();
                    doc.text(`Результат: ${qualityText}`, 20, 90);
                }
                
                doc.save(`relevance_analysis_${currentConfig.name.toLowerCase()}_${new Date().toISOString().split('T')[0]}.pdf`);
                showMessage('PDF-отчет экспортирован', 'success');
            } catch (error) {
                showMessage(`Ошибка экспорта PDF: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
