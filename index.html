<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ 2.0 (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .upload-section {
            padding: 40px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .setting-block {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }
        
        .setting-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }
        
        .category-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .category-option {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .category-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .category-option.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .limit-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .slider-value {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            margin-top: 5px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 auto;
            display: block;
            text-align: center;
            width: fit-content;
        }
        
        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .preview-section {
            padding: 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: none;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .preview-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .preview-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .preview-examples {
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            padding: 40px;
            display: none;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-card.excellent { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.good { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-card.satisfactory { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-card.poor { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }
        
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .comparison-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 30px 0;
        }
        
        .comparison-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .comparison-table tr:hover {
            background: #f8f9fa;
        }
        
        .characteristics-importance {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .characteristics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .characteristic-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: help;
        }
        
        .characteristic-percentage {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }
        
        .characteristic-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .quality-rating {
            text-align: center;
            padding: 25px;
            margin: 30px 0;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .quality-excellent { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2d3748; }
        .quality-good { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2d3748; }
        .quality-satisfactory { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; }
        .quality-poor { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #2d3748; }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .example-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .example-item.good {
            border-left-color: #38a169;
        }
        
        .example-item.bad {
            border-left-color: #e53e3e;
        }
        
        .query, .title {
            margin-bottom: 8px;
        }
        
        .query {
            font-weight: 600;
            color: #2d3748;
        }
        
        .title {
            color: #4a5568;
        }
        
        .reason {
            color: #e53e3e;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #e53e3e;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #2d5a27;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #38a169;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version-badge">–í–µ—Ä—Å–∏—è 2.0 (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è)</div>
            <h1>üîç –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤</h1>
            <p>–ú–Ω–æ–≥–æ–∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏</p>
        </div>
        
        <div class="upload-section">
            <div class="settings-grid">
                <div class="setting-block">
                    <div class="setting-title">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>
                    <div class="category-selector">
                        <div class="category-option active" data-category="klapany">–ö–ª–∞–ø–∞–Ω—ã</div>
                        <div class="category-option" data-category="krany">–ö—Ä–∞–Ω—ã</div>
                        <div class="category-option" data-category="zadvijki">–ó–∞–¥–≤–∏–∂–∫–∏</div>
                        <div class="category-option" data-category="auto">–ê–≤—Ç–æ</div>
                    </div>
                </div>
                
                <div class="setting-block">
                    <div class="setting-title">üìä –õ–∏–º–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
                    <input type="range" class="limit-slider" min="100" max="10000" value="1000" step="100" id="limitSlider">
                    <div class="slider-value" id="sliderValue">1000 –∑–∞–ø–∏—Å–µ–π</div>
                </div>
            </div>
            
            <div class="file-input-wrapper">
                <input type="file" class="file-input" accept=".xlsx,.xls" id="fileInput">
                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª Excel
            </div>
            <p style="margin-top: 15px; text-align: center; color: #666;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã .xlsx –∏ .xls</p>
            
            <div id="messageArea"></div>
        </div>
        
        <div class="preview-section" id="previewSection">
            <h3 class="section-title">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
            <div class="preview-grid" id="previewGrid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="export-btn" id="startAnalysis">üöÄ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...</p>
        </div>
        
        <div class="results" id="results">
            <div class="results-header">
                <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>
                <button class="export-btn" id="exportPdf">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
            </div>
            
            <div class="stats-grid" id="statsGrid"></div>
            <div class="quality-rating" id="qualityRating"></div>
            
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>–¢–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å</th>
                            <th>–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody"></tbody>
                </table>
            </div>
            
            <div class="characteristics-importance">
                <h3>üéØ –í–∞–∂–Ω–æ—Å—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö</h3>
                <p>–ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —É–ø–æ–º–∏–Ω–∞–µ–º—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</p>
                <div class="characteristics-grid" id="characteristicsGrid"></div>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="products">–¢–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</button>
                <button class="tab" data-tab="listings">–°—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∏–Ω–≥–∞</button>
                <button class="tab" data-tab="problems">–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º</button>
            </div>
            
            <div class="tab-content active" id="products-content"></div>
            <div class="tab-content" id="listings-content"></div>
            <div class="tab-content" id="problems-content"></div>
        </div>
    </div>

    <script>
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ò –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
        const TECHNICAL_ABBREVIATIONS = {
            '–∫—à': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π',
            '–∫—à–º': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π –º—É—Ñ—Ç–æ–≤—ã–π',
            '–∫—à—Ñ': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π —Ñ–ª–∞–Ω—Ü–µ–≤—ã–π',
            '–∫—à—Ç': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π —Ç—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π',
            '–∫—à–ø': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π —Å –ø–Ω–µ–≤–º–æ–ø—Ä–∏–≤–æ–¥–æ–º',
            '–∫—à—ç': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π —Å —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–≤–æ–¥–æ–º',
            '–∫–æ': '–∫–ª–∞–ø–∞–Ω –æ–±—Ä–∞—Ç–Ω—ã–π',
            '–∫–±': '–∫–ª–∞–ø–∞–Ω –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–æ—á–Ω—ã–π',
            '–∫–ø': '–∫–ª–∞–ø–∞–Ω –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω—ã–π',
            '–∫—Ä': '–∫–ª–∞–ø–∞–Ω —Ä–µ–≥—É–ª–∏—Ä—É—é—â–∏–π',
            '–∑–∫': '–∑–∞–¥–≤–∏–∂–∫–∞ –∫–ª–∏–Ω–æ–≤–∞—è',
            '–∑—à': '–∑–∞–¥–≤–∏–∂–∫–∞ —à–∏–±–µ—Ä–Ω–∞—è'
        };

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const CONFIG = {
            klapany: {
                name: '–ö–ª–∞–ø–∞–Ω—ã',
                productTypes: ['–∫–ª–∞–ø–∞–Ω', '–≤–µ–Ω—Ç–∏–ª—å', '–æ–±—Ä–∞—Ç–Ω—ã–π', '–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–æ—á–Ω—ã–π', '–ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω—ã–π', '—Ä–µ–≥—É–ª–∏—Ä—É—é—â–∏–π'],
                synonymGroups: [
                    ['–∫–ª–∞–ø–∞–Ω', '–≤–µ–Ω—Ç–∏–ª—å'],
                    ['–æ–±—Ä–∞—Ç–Ω—ã–π', '–Ω–µ–≤–æ–∑–≤—Ä–∞—Ç–Ω—ã–π'],
                    ['–º—É—Ñ—Ç–æ–≤—ã–π', '—Ä–µ–∑—å–±–æ–≤–æ–π']
                ],
                technicalCodes: ['–∫–æ', '–∫–±', '–∫–ø', '–∫—Ä']
            },
            krany: {
                name: '–ö—Ä–∞–Ω—ã',
                productTypes: ['–∫—Ä–∞–Ω', '—à–∞—Ä–æ–≤–æ–π', '–ø—Ä–æ–±–∫–æ–≤—ã–π', '–∏–≥–æ–ª—å—á–∞—Ç—ã–π'],
                synonymGroups: [
                    ['–∫—Ä–∞–Ω', '—à–∞—Ä–æ–≤–æ–π –∫—Ä–∞–Ω'],
                    ['–ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π', '–ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ö–æ–¥'],
                    ['—Ç—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π', '3-—Ö —Ö–æ–¥–æ–≤–æ–π']
                ],
                technicalCodes: ['–∫—à', '–∫—à–º', '–∫—à—Ñ', '–∫—à—Ç', '–∫—à–ø', '–∫—à—ç']
            },
            zadvijki: {
                name: '–ó–∞–¥–≤–∏–∂–∫–∏',
                productTypes: ['–∑–∞–¥–≤–∏–∂–∫–∞', '–∫–ª–∏–Ω–æ–≤–∞—è', '—à–∏–±–µ—Ä–Ω–∞—è', '–¥–∏—Å–∫–æ–≤–∞—è'],
                synonymGroups: [
                    ['—à–∏–±–µ—Ä–Ω–∞—è', '–Ω–æ–∂–µ–≤–∞—è'],
                    ['–≤—ã–¥–≤–∏–∂–Ω–æ–π', '–≤—ã–¥–≤–∏–∂–Ω–æ–π —à–ø–∏–Ω–¥–µ–ª—å']
                ],
                technicalCodes: ['–∑–∫', '–∑—à']
            },
            auto: {
                name: '–ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ',
                productTypes: [],
                synonymGroups: [],
                technicalCodes: []
            }
        };

        let currentData = null;
        let currentConfig = CONFIG.krany; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫—Ä–∞–Ω—ã, —Ç–∞–∫ –∫–∞–∫ —Ñ–∞–π–ª —Å –∫—Ä–∞–Ω–∞–º–∏
        let processLimit = 1000;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initializeInterface();
        });

        function initializeInterface() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            document.querySelectorAll('.category-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.category-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    const category = this.dataset.category;
                    currentConfig = CONFIG[category];
                    showMessage(`–í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${currentConfig.name}`, 'success');
                });
            });

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–∞–π–¥–µ—Ä–∞
            const slider = document.getElementById('limitSlider');
            const sliderValue = document.getElementById('sliderValue');
            
            slider.addEventListener('input', function() {
                processLimit = parseInt(this.value);
                sliderValue.textContent = `${processLimit} –∑–∞–ø–∏—Å–µ–π`;
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('startAnalysis').addEventListener('click', startAnalysis);
            document.getElementById('exportPdf').addEventListener('click', exportToPdf);

            // –¢–∞–±—ã
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
        }

        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'error' ? 'error-message' : 'success-message';
            messageArea.innerHTML = `<div class="${className}">${text}</div>`;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showMessage(`–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ñ–∞–π–ª: ${file.name}`, 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏—Å—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö');
                    }
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (!jsonData || jsonData.length < 2) {
                        throw new Error('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å—Ç—Ä–æ–∫–∏ (–∑–∞–≥–æ–ª–æ–≤–∫–∏ + –¥–∞–Ω–Ω—ã–µ)');
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
                    const headers = jsonData[0];
                    if (!headers || headers.length < 4) {
                        throw new Error('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 –∫–æ–ª–æ–Ω–∫–∏: –∑–∞–ø—Ä–æ—Å, –∫–∞–º–ø–∞–Ω–∏—è, url, title');
                    }
                    
                    currentData = jsonData;
                    showMessage(`–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω: ${jsonData.length - 1} –∑–∞–ø–∏—Å–µ–π`, 'success');
                    showPreview(jsonData);
                } catch (error) {
                    console.error('Error processing file:', error);
                    showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function showPreview(data) {
            try {
                const rows = data.slice(1).filter(row => row && row[0] && row[3]);
                
                if (rows.length === 0) {
                    showMessage('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏', 'error');
                    return;
                }

                const sample = rows.slice(0, 50);
                const preview = classifyPreview(sample);
                
                const previewGrid = document.getElementById('previewGrid');
                previewGrid.innerHTML = `
                    <div class="preview-card">
                        <div class="preview-title">üõí –¢–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (${preview.products.count})</div>
                        <div class="preview-examples">
                            <div style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                –°—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
                            </div>
                            ${preview.products.examples.slice(0, 3).map(ex => 
                                `<div style="margin: 8px 0; padding: 8px; background: #f0f8f0; border-radius: 4px; font-size: 0.8rem;">
                                    <strong>–ó–∞–ø—Ä–æ—Å:</strong> ${ex.query}<br>
                                    <strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${ex.title}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="preview-card">
                        <div class="preview-title">üìã –°—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∏–Ω–≥–∞ (${preview.listings.count})</div>
                        <div class="preview-examples">
                            <div style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                –ö–∞—Ç–∞–ª–æ–≥–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫—Ä–∞—Ç–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
                            </div>
                            ${preview.listings.examples.slice(0, 3).map(ex => 
                                `<div style="margin: 8px 0; padding: 8px; background: #f8f0f0; border-radius: 4px; font-size: 0.8rem;">
                                    <strong>–ó–∞–ø—Ä–æ—Å:</strong> ${ex.query}<br>
                                    <strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${ex.title}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('previewSection').style.display = 'block';
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ${error.message}`, 'error');
            }
        }

        function classifyPreview(sample) {
            const classifications = {
                products: { count: 0, examples: [] },
                listings: { count: 0, examples: [] }
            };

            sample.forEach(row => {
                if (!row || !Array.isArray(row)) return;

                const query = row[0] || '';
                const url = row[2] || '';
                const title = row[3] || '';
                
                const classification = classifyPage(url, title);
                classifications[classification].count++;
                
                if (classifications[classification].examples.length < 5) {
                    classifications[classification].examples.push({
                        query: query.length > 60 ? query.substring(0, 60) + '...' : query,
                        title: title.length > 80 ? title.substring(0, 80) + '...' : title
                    });
                }
            });

            return classifications;
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–ò
        function classifyPage(url, title) {
            // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
            const titleLower = title.toLowerCase();
            
            // –ü—Ä–∏–∑–Ω–∞–∫–∏ —Ç–æ–≤–∞—Ä–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
            const hasDetailedSpecs = /–¥—É\s*\d+|dn\s*\d+|—Ä—É\s*\d+|pn\s*\d+|\d+\s*–º–º|\d+"|1\/2|3\/4/i.test(title);
            const hasModelNumber = /[A-Z0-9]{2,}[-\(\)A-Z0-9]*\d/i.test(title);
            const hasDetailedDescription = title.length > 50;
            const hasTechnicalTerms = /(–Ω–µ—Ä–∂–∞–≤–µ—é—â–∞—è|–ª–∞—Ç—É–Ω—å|—á—É–≥—É–Ω|–ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π|—Ñ–ª–∞–Ω—Ü–µ–≤—ã–π|–º—É—Ñ—Ç–æ–≤—ã–π|—Ä–µ–∑—å–±–æ–≤–æ–π|–ø—Ä–∏–≤–æ–¥|—Ä—ã—á–∞–≥)/i.test(title);
            
            // –ü—Ä–∏–∑–Ω–∞–∫–∏ –ª–∏—Å—Ç–∏–Ω–≥–∞:
            const isCatalogPage = /(–∫–∞—Ç–∞–ª–æ–≥|–∫–∞—Ç–µ–≥–æ—Ä–∏—è|–≤—Å–µ|–ø–æ–¥–±–æ—Ä|–≤—ã–±–æ—Ä|—Å–µ—Ä–∏—è|–ª–∏–Ω–µ–π–∫–∞)/i.test(title);
            const isBrandPage = /^[A-Z\s]+$/i.test(title.trim()) && title.length < 30;
            const isGenericTitle = title.length < 30 && !hasDetailedSpecs;
            
            // –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è
            if (isCatalogPage || isBrandPage || isGenericTitle) {
                return 'listings';
            }
            
            if (hasDetailedSpecs && (hasModelNumber || hasTechnicalTerms) && hasDetailedDescription) {
                return 'products';
            }
            
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–Ω–æ—Å–∏–º –∫ –ª–∏—Å—Ç–∏–Ω–≥–∞–º
            return 'listings';
        }

        function startAnalysis() {
            if (!currentData) {
                showMessage('–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'error');
                return;
            }

            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏
            setTimeout(() => {
                try {
                    analyzeData(currentData);
                } catch (error) {
                    console.error('Error in analysis:', error);
                    document.getElementById('loading').style.display = 'none';
                    showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: ${error.message}`, 'error');
                }
            }, 500);
        }

        function analyzeData(data) {
            try {
                const rows = data.slice(1).filter(row => row && row[0] && row[3]);
                const sampleSize = Math.min(rows.length, processLimit);
                const sample = rows.slice(0, sampleSize);

                // –ê–Ω–∞–ª–∏–∑ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
                const characteristicsAnalysis = analyzeCharacteristics(sample);

                // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
                const results = {
                    total: sampleSize,
                    products: [],
                    listings: [],
                    characteristics: characteristicsAnalysis
                };

                // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
                sample.forEach(row => {
                    const query = row[0] || '';
                    const url = row[2] || '';
                    const title = row[3] || '';
                    
                    const classification = classifyPage(url, title);
                    const relevanceResult = analyzeRelevance(query, title, classification);
                    
                    results[classification].push({
                        query,
                        url,
                        title,
                        relevance: relevanceResult
                    });
                });

                displayResults(results);
            } catch (error) {
                console.error('Error in analyzeData:', error);
                document.getElementById('loading').style.display = 'none';
                showMessage(`–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
            }
        }

        function analyzeCharacteristics(sample) {
            const characteristics = {};
            
            const patterns = [
                { pattern: /–¥—É\s*(\d+)/gi, name: '–î–∏–∞–º–µ—Ç—Ä –î–£', category: 'size' },
                { pattern: /dn\s*(\d+)/gi, name: '–î–∏–∞–º–µ—Ç—Ä DN', category: 'size' },
                { pattern: /—Ä—É\s*(\d+)/gi, name: '–î–∞–≤–ª–µ–Ω–∏–µ –†–£', category: 'pressure' },
                { pattern: /pn\s*(\d+)/gi, name: '–î–∞–≤–ª–µ–Ω–∏–µ PN', category: 'pressure' },
                { pattern: /(\d+)\s*–º–º/gi, name: '–†–∞–∑–º–µ—Ä –≤ –º–º', category: 'size' },
                { pattern: /–ª–∞—Ç—É–Ω/gi, name: '–õ–∞—Ç—É–Ω—å', category: 'material' },
                { pattern: /–Ω–µ—Ä–∂–∞–≤/gi, name: '–ù–µ—Ä–∂–∞–≤–µ—é—â–∞—è —Å—Ç–∞–ª—å', category: 'material' },
                { pattern: /–º—É—Ñ—Ç–æ–≤/gi, name: '–ú—É—Ñ—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', category: 'connection' },
                { pattern: /—Ñ–ª–∞–Ω—Ü/gi, name: '–§–ª–∞–Ω—Ü–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', category: 'connection' }
            ];
            
            sample.forEach(row => {
                if (!row || !row[0]) return;
                
                const query = row[0].toLowerCase();
                
                patterns.forEach(({ pattern, name, category }) => {
                    const regex = new RegExp(pattern.source, pattern.flags);
                    if (regex.test(query)) {
                        const key = `${category}_${name}`;
                        if (!characteristics[key]) {
                            characteristics[key] = {
                                name: name,
                                category: category,
                                count: 0,
                                total: sample.length
                            };
                        }
                        characteristics[key].count++;
                    }
                });
            });

            // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
            Object.keys(characteristics).forEach(key => {
                characteristics[key].percentage = Math.round(
                    (characteristics[key].count / characteristics[key].total) * 100
                );
            });

            return characteristics;
        }

        function analyzeRelevance(query, title, pageType) {
            const queryInfo = extractInfo(query);
            const titleInfo = extractInfo(title);
            
            if (queryInfo.types.length === 0) {
                return { relevant: false, reason: '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ' };
            }
            
            if (titleInfo.types.length === 0) {
                return { relevant: false, reason: '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ' };
            }
            
            if (!areTypesCompatible(queryInfo.types, titleInfo.types)) {
                return { relevant: false, reason: '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞' };
            }
            
            return { relevant: true, reason: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º' };
        }

        function extractInfo(text) {
            const normalized = text.toLowerCase().replace(/[^\w–∞-—è]/g, ' ').replace(/\s+/g, ' ').trim();
            let foundTypes = [];
            
            // –ü–æ–∏—Å–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∫–æ–¥–æ–≤
            for (let [code, expansion] of Object.entries(TECHNICAL_ABBREVIATIONS)) {
                if (normalized.includes(code)) {
                    foundTypes.push(...expansion.split(' '));
                }
            }
            
            // –ü–æ–∏—Å–∫ —Ç–∏–ø–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
            if (currentConfig.productTypes) {
                for (let type of currentConfig.productTypes) {
                    if (normalized.includes(type)) {
                        foundTypes.push(type);
                    }
                }
            }
            
            return { types: [...new Set(foundTypes)] };
        }

        function areTypesCompatible(queryTypes, titleTypes) {
            if (!queryTypes.length || !titleTypes.length) return false;
            
            // –ü—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            for (let qType of queryTypes) {
                if (titleTypes.includes(qType)) return true;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
            if (currentConfig.synonymGroups) {
                for (let group of currentConfig.synonymGroups) {
                    let queryHas = queryTypes.some(t => group.includes(t));
                    let titleHas = titleTypes.some(t => group.includes(t));
                    if (queryHas && titleHas) return true;
                }
            }
            
            return false;
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø calculateOverallStats
        function calculateOverallStats(results) {
            const productRelevant = results.products.filter(item => item.relevance.relevant).length;
            const listingRelevant = results.listings.filter(item => item.relevance.relevant).length;
            
            // –í–µ—Å–æ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã: —Ç–æ–≤–∞—Ä—ã 100%, –ª–∏—Å—Ç–∏–Ω–≥–∏ 50%
            const weightedTotal = results.products.length * 1.0 + results.listings.length * 0.5;
            const weightedRelevant = productRelevant * 1.0 + listingRelevant * 0.5;
            const overallPercentage = weightedTotal > 0 ? (weightedRelevant / weightedTotal * 100).toFixed(1) : 0;

            return {
                total: results.total,
                products: results.products.length,
                listings: results.listings.length,
                overallPercentage: overallPercentage
            };
        }

        function calculateStats(pageData) {
            if (!pageData || !Array.isArray(pageData)) {
                return { total: 0, relevant: 0, irrelevant: 0, percentage: 0, problems: {} };
            }

            const total = pageData.length;
            const relevant = pageData.filter(item => item.relevance && item.relevance.relevant).length;
            const percentage = total > 0 ? (relevant / total * 100).toFixed(1) : 0;
            
            const problems = {};
            pageData.filter(item => item.relevance && !item.relevance.relevant).forEach(item => {
                const reason = item.relevance.reason || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞';
                problems[reason] = (problems[reason] || 0) + 1;
            });

            return { total, relevant, irrelevant: total - relevant, percentage, problems };
        }

        function displayResults(results) {
            try {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';

                const productStats = calculateStats(results.products);
                const listingStats = calculateStats(results.listings);
                const overallStats = calculateOverallStats(results);

                // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                displayOverallStats(overallStats);
                
                // –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                displayComparisonTable(productStats, listingStats);
                
                // –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                displayCharacteristicsImportance(results.characteristics);
                
                // –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ —Ç–∞–±–∞–º
                displayTabContent(results, productStats, listingStats);

                showMessage('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
            } catch (error) {
                console.error('Error in displayResults:', error);
                showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${error.message}`, 'error');
            }
        }

        function displayOverallStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card excellent">
                    <span class="stat-value">${stats.total}</span>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                </div>
                <div class="stat-card good">
                    <span class="stat-value">${stats.products}</span>
                    <div class="stat-label">–¢–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</div>
                </div>
                <div class="stat-card satisfactory">
                    <span class="stat-value">${stats.listings}</span>
                    <div class="stat-label">–°—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∏–Ω–≥–∞</div>
                </div>
                <div class="stat-card poor">
                    <span class="stat-value">${stats.overallPercentage}%</span>
                    <div class="stat-label">–û–±—â–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å</div>
                </div>
            `;

            const qualityRating = document.getElementById('qualityRating');
            const percentage = parseFloat(stats.overallPercentage);
            let qualityClass, qualityText;
            
            if (percentage >= 90) {
                qualityClass = 'quality-excellent';
                qualityText = 'üü¢ –û–¢–õ–ò–ß–ù–û';
            } else if (percentage >= 80) {
                qualityClass = 'quality-good';
                qualityText = 'üü° –•–û–†–û–®–û';
            } else if (percentage >= 70) {
                qualityClass = 'quality-satisfactory';
                qualityText = 'üü† –£–î–û–í–õ–ï–¢–í–û–†–ò–¢–ï–õ–¨–ù–û';
            } else {
                qualityClass = 'quality-poor';
                qualityText = 'üî¥ –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø';
            }
            
            qualityRating.className = `quality-rating ${qualityClass}`;
            qualityRating.innerHTML = `${qualityText}<br><span style="font-size: 1.2rem;">–û–±—â–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${stats.overallPercentage}%</span>`;
        }

        function displayComparisonTable(productStats, listingStats) {
            const comparisonBody = document.getElementById('comparisonBody');
            
            const getTopProblems = (problems) => {
                if (!problems || typeof problems !== 'object') return '–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º';
                const sorted = Object.entries(problems).sort((a, b) => b[1] - a[1]);
                return sorted.slice(0, 2).map(([problem, count]) => `${problem} (${count})`).join(', ') || '–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º';
            };

            comparisonBody.innerHTML = `
                <tr>
                    <td><strong>–¢–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</strong></td>
                    <td>${productStats.total}</td>
                    <td><span style="color: ${productStats.percentage >= 80 ? '#38a169' : '#e53e3e'}">${productStats.percentage}%</span></td>
                    <td>${getTopProblems(productStats.problems)}</td>
                </tr>
                <tr>
                    <td><strong>–°—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∏–Ω–≥–∞</strong></td>
                    <td>${listingStats.total}</td>
                    <td><span style="color: ${listingStats.percentage >= 70 ? '#38a169' : '#e53e3e'}">${listingStats.percentage}%</span></td>
                    <td>${getTopProblems(listingStats.problems)}</td>
                </tr>
            `;
        }

        function displayCharacteristicsImportance(characteristics) {
            const characteristicsGrid = document.getElementById('characteristicsGrid');
            
            const filteredChars = Object.entries(characteristics)
                .filter(([key, data]) => data.percentage >= 1)
                .sort((a, b) => b[1].percentage - a[1].percentage)
                .slice(0, 12);

            if (filteredChars.length === 0) {
                characteristicsGrid.innerHTML = '<p style="text-align: center; opacity: 0.7;">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            characteristicsGrid.innerHTML = filteredChars.map(([key, data]) => `
                <div class="characteristic-item">
                    <span class="characteristic-percentage">${data.percentage}%</span>
                    <div class="characteristic-label">${data.name}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">${data.count}/${data.total}</div>
                </div>
            `).join('');
        }

        function displayTabContent(results, productStats, listingStats) {
            // –¢–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const productsContent = document.getElementById('products-content');
            const productExamples = getExamples(results.products, 5);
            
            productsContent.innerHTML = `
                <h3 class="section-title">‚úÖ –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π (${productExamples.good.length})</h3>
                ${productExamples.good.map(example => `
                    <div class="example-item good">
                        <div class="query"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ${example.query}</div>
                        <div class="title"><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${example.title}</div>
                    </div>
                `).join('')}
                
                <h3 class="section-title">‚ùå –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (${productExamples.bad.length})</h3>
                ${productExamples.bad.map(example => `
                    <div class="example-item bad">
                        <div class="query"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ${example.query}</div>
                        <div class="title"><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${example.title}</div>
                        <div class="reason"><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> ${example.relevance.reason}</div>
                    </div>
                `).join('')}
            `;

            // –°—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∏–Ω–≥–∞
            const listingsContent = document.getElementById('listings-content');
            const listingExamples = getExamples(results.listings, 5);
            
            listingsContent.innerHTML = `
                <p style="margin-bottom: 20px; color: #666;">–°—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–æ–≤, –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –∫—Ä–∞—Ç–∫–∏—Ö –æ–ø–∏—Å–∞–Ω–∏–π (–≤–µ—Å 50%)</p>
                
                <h3 class="section-title">‚úÖ –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π (${listingExamples.good.length})</h3>
                ${listingExamples.good.map(example => `
                    <div class="example-item good">
                        <div class="query"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ${example.query}</div>
                        <div class="title"><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${example.title}</div>
                    </div>
                `).join('')}
                
                <h3 class="section-title">‚ùå –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (${listingExamples.bad.length})</h3>
                ${listingExamples.bad.map(example => `
                    <div class="example-item bad">
                        <div class="query"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ${example.query}</div>
                        <div class="title"><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${example.title}</div>
                        <div class="reason"><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> ${example.relevance.reason}</div>
                    </div>
                `).join('')}
            `;

            // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º
            const problemsContent = document.getElementById('problems-content');
            const allProblems = { ...productStats.problems, ...listingStats.problems };
            
            problemsContent.innerHTML = `
                <h3 class="section-title">üîç –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –ø—Ä–æ–±–ª–µ–º</h3>
                ${Object.entries(allProblems).sort((a, b) => b[1] - a[1]).map(([problem, count]) => `
                    <div class="example-item">
                        <div class="query"><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> ${problem}</div>
                        <div class="title"><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É—á–∞–µ–≤:</strong> ${count}</div>
                        <div style="color: #666; margin-top: 10px;">
                            ${getProblemsolution(problem)}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getProblemsolution(problem) {
            const solutions = {
                '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ': '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —è–¥—Ä–æ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤',
                '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ': '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤',
                '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞': '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ landing page –∑–∞–ø—Ä–æ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'
            };
            return solutions[problem] || '–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑';
        }

        function getExamples(data, limit) {
            if (!data || !Array.isArray(data)) {
                return { good: [], bad: [] };
            }

            const good = data.filter(item => item.relevance && item.relevance.relevant).slice(0, limit);
            const bad = data.filter(item => item.relevance && !item.relevance.relevant).slice(0, limit);
            return { good, bad };
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        function exportToPdf() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('–ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${currentConfig.name}`, 20, 50);
                doc.text(`–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: ${new Date().toLocaleDateString('ru-RU')}`, 20, 60);
                
                const qualityElement = document.getElementById('qualityRating');
                if (qualityElement) {
                    const qualityText = qualityElement.textContent.replace(/\s+/g, ' ').trim();
                    doc.text(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${qualityText}`, 20, 80);
                }
                
                doc.save(`relevance_analysis_${new Date().toISOString().split('T')[0]}.pdf`);
                showMessage('PDF-–æ—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
