<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор релевантности 2.0 (Исправленный)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .upload-section {
            padding: 40px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .setting-block {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }
        
        .setting-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }
        
        .category-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .category-option {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .category-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .category-option.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .limit-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .slider-value {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            margin-top: 5px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 auto;
            display: block;
            text-align: center;
            width: fit-content;
        }
        
        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .preview-section {
            padding: 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: none;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .preview-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .preview-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .preview-examples {
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            padding: 40px;
            display: none;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-card.excellent { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.good { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-card.satisfactory { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-card.poor { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }
        
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .comparison-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 30px 0;
        }
        
        .comparison-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .comparison-table tr:hover {
            background: #f8f9fa;
        }
        
        .characteristics-importance {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .characteristics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .characteristic-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: help;
        }
        
        .characteristic-percentage {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }
        
        .characteristic-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .quality-rating {
            text-align: center;
            padding: 25px;
            margin: 30px 0;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .quality-excellent { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2d3748; }
        .quality-good { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2d3748; }
        .quality-satisfactory { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; }
        .quality-poor { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #2d3748; }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .example-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .example-item.good {
            border-left-color: #38a169;
        }
        
        .example-item.bad {
            border-left-color: #e53e3e;
        }
        
        .query, .title {
            margin-bottom: 8px;
        }
        
        .query {
            font-weight: 600;
            color: #2d3748;
        }
        
        .title {
            color: #4a5568;
        }
        
        .reason {
            color: #e53e3e;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #e53e3e;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #2d5a27;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #38a169;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version-badge">Версия 2.0 (Исправленная)</div>
            <h1>🔍 Анализатор релевантности заголовков</h1>
            <p>Многокатегорийный анализ с классификацией страниц и исправленными алгоритмами</p>
        </div>
        
        <div class="upload-section">
            <div class="settings-grid">
                <div class="setting-block">
                    <div class="setting-title">📂 Категория оборудования</div>
                    <div class="category-selector">
                        <div class="category-option active" data-category="klapany">Клапаны</div>
                        <div class="category-option" data-category="krany">Краны</div>
                        <div class="category-option" data-category="zadvijki">Задвижки</div>
                        <div class="category-option" data-category="auto">Авто</div>
                    </div>
                </div>
                
                <div class="setting-block">
                    <div class="setting-title">📊 Лимит обработки</div>
                    <input type="range" class="limit-slider" min="100" max="10000" value="1000" step="100" id="limitSlider">
                    <div class="slider-value" id="sliderValue">1000 записей</div>
                </div>
            </div>
            
            <div class="file-input-wrapper">
                <input type="file" class="file-input" accept=".xlsx,.xls" id="fileInput">
                📁 Загрузить файл Excel
            </div>
            <p style="margin-top: 15px; text-align: center; color: #666;">Поддерживаются файлы .xlsx и .xls</p>
            
            <div id="messageArea"></div>
        </div>
        
        <div class="preview-section" id="previewSection">
            <h3 class="section-title">👀 Предпросмотр классификации</h3>
            <div class="preview-grid" id="previewGrid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="export-btn" id="startAnalysis">🚀 Начать анализ</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Анализируем данные...</p>
        </div>
        
        <div class="results" id="results">
            <div class="results-header">
                <h2>📊 Результаты анализа</h2>
                <button class="export-btn" id="exportPdf">📄 Экспорт в PDF</button>
            </div>
            
            <div class="stats-grid" id="statsGrid"></div>
            <div class="quality-rating" id="qualityRating"></div>
            
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>Тип страниц</th>
                            <th>Количество</th>
                            <th>Релевантность</th>
                            <th>Основные проблемы</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody"></tbody>
                </table>
            </div>
            
            <div class="characteristics-importance">
                <h3>🎯 Важность характеристик в запросах</h3>
                <p>Анализ всех упоминаемых технических параметров</p>
                <div class="characteristics-grid" id="characteristicsGrid"></div>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="products">Товарные страницы</button>
                <button class="tab" data-tab="listings">Страницы листинга</button>
                <button class="tab" data-tab="problems">Анализ проблем</button>
            </div>
            
            <div class="tab-content active" id="products-content"></div>
            <div class="tab-content" id="listings-content"></div>
            <div class="tab-content" id="problems-content"></div>
        </div>
    </div>

    <script>
        // ИСПРАВЛЕННАЯ И ОПТИМИЗИРОВАННАЯ ВЕРСИЯ
        
        // Конфигурация технических сокращений
        const TECHNICAL_ABBREVIATIONS = {
            'кш': 'кран шаровой',
            'кшм': 'кран шаровой муфтовый',
            'кшф': 'кран шаровой фланцевый',
            'кшт': 'кран шаровой трехходовой',
            'кшп': 'кран шаровой с пневмоприводом',
            'кшэ': 'кран шаровой с электроприводом',
            'ко': 'клапан обратный',
            'кб': 'клапан балансировочный',
            'кп': 'клапан предохранительный',
            'кр': 'клапан регулирующий',
            'зк': 'задвижка клиновая',
            'зш': 'задвижка шиберная'
        };

        // Конфигурация категорий
        const CONFIG = {
            klapany: {
                name: 'Клапаны',
                productTypes: ['клапан', 'вентиль', 'обратный', 'балансировочный', 'предохранительный', 'регулирующий'],
                synonymGroups: [
                    ['клапан', 'вентиль'],
                    ['обратный', 'невозвратный'],
                    ['муфтовый', 'резьбовой']
                ],
                technicalCodes: ['ко', 'кб', 'кп', 'кр']
            },
            krany: {
                name: 'Краны',
                productTypes: ['кран', 'шаровой', 'пробковый', 'игольчатый'],
                synonymGroups: [
                    ['кран', 'шаровой кран'],
                    ['полнопроходной', 'полный проход'],
                    ['трехходовой', '3-х ходовой']
                ],
                technicalCodes: ['кш', 'кшм', 'кшф', 'кшт', 'кшп', 'кшэ']
            },
            zadvijki: {
                name: 'Задвижки',
                productTypes: ['задвижка', 'клиновая', 'шиберная', 'дисковая'],
                synonymGroups: [
                    ['шиберная', 'ножевая'],
                    ['выдвижной', 'выдвижной шпиндель']
                ],
                technicalCodes: ['зк', 'зш']
            },
            auto: {
                name: 'Авто-определение',
                productTypes: [],
                synonymGroups: [],
                technicalCodes: []
            }
        };

        let currentData = null;
        let currentConfig = CONFIG.krany; // По умолчанию краны, так как файл с кранами
        let processLimit = 1000;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initializeInterface();
        });

        function initializeInterface() {
            // Настройка категорий
            document.querySelectorAll('.category-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.category-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    const category = this.dataset.category;
                    currentConfig = CONFIG[category];
                    showMessage(`Выбрана категория: ${currentConfig.name}`, 'success');
                });
            });

            // Настройка слайдера
            const slider = document.getElementById('limitSlider');
            const sliderValue = document.getElementById('sliderValue');
            
            slider.addEventListener('input', function() {
                processLimit = parseInt(this.value);
                sliderValue.textContent = `${processLimit} записей`;
            });

            // Загрузка файла
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('startAnalysis').addEventListener('click', startAnalysis);
            document.getElementById('exportPdf').addEventListener('click', exportToPdf);

            // Табы
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
        }

        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'error' ? 'error-message' : 'success-message';
            messageArea.innerHTML = `<div class="${className}">${text}</div>`;
            
            // Автоматически скрыть сообщение через 5 секунд
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showMessage(`Загружается файл: ${file.name}`, 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('Файл не содержит листов данных');
                    }
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (!jsonData || jsonData.length < 2) {
                        throw new Error('Файл должен содержать минимум 2 строки (заголовки + данные)');
                    }
                    
                    // Проверка структуры данных
                    const headers = jsonData[0];
                    if (!headers || headers.length < 4) {
                        throw new Error('Файл должен содержать минимум 4 колонки: запрос, кампания, url, title');
                    }
                    
                    currentData = jsonData;
                    showMessage(`Файл успешно загружен: ${jsonData.length - 1} записей`, 'success');
                    showPreview(jsonData);
                } catch (error) {
                    console.error('Error processing file:', error);
                    showMessage(`Ошибка при обработке файла: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('Ошибка при чтении файла', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function showPreview(data) {
            try {
                const rows = data.slice(1).filter(row => row && row[0] && row[3]);
                
                if (rows.length === 0) {
                    showMessage('В файле не найдены строки с заполненными запросами и заголовками', 'error');
                    return;
                }

                const sample = rows.slice(0, 50);
                const preview = classifyPreview(sample);
                
                const previewGrid = document.getElementById('previewGrid');
                previewGrid.innerHTML = `
                    <div class="preview-card">
                        <div class="preview-title">🛒 Товарные страницы (${preview.products.count})</div>
                        <div class="preview-examples">
                            <div style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                Страницы с подробными техническими характеристиками
                            </div>
                            ${preview.products.examples.slice(0, 3).map(ex => 
                                `<div style="margin: 8px 0; padding: 8px; background: #f0f8f0; border-radius: 4px; font-size: 0.8rem;">
                                    <strong>Запрос:</strong> ${ex.query}<br>
                                    <strong>Заголовок:</strong> ${ex.title}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="preview-card">
                        <div class="preview-title">📋 Страницы листинга (${preview.listings.count})</div>
                        <div class="preview-examples">
                            <div style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                Каталоги, категории, краткие описания
                            </div>
                            ${preview.listings.examples.slice(0, 3).map(ex => 
                                `<div style="margin: 8px 0; padding: 8px; background: #f8f0f0; border-radius: 4px; font-size: 0.8rem;">
                                    <strong>Запрос:</strong> ${ex.query}<br>
                                    <strong>Заголовок:</strong> ${ex.title}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('previewSection').style.display = 'block';
            } catch (error) {
                showMessage(`Ошибка при отображении предпросмотра: ${error.message}`, 'error');
            }
        }

        function classifyPreview(sample) {
            const classifications = {
                products: { count: 0, examples: [] },
                listings: { count: 0, examples: [] }
            };

            sample.forEach(row => {
                if (!row || !Array.isArray(row)) return;

                const query = row[0] || '';
                const url = row[2] || '';
                const title = row[3] || '';
                
                const classification = classifyPage(url, title);
                classifications[classification].count++;
                
                if (classifications[classification].examples.length < 5) {
                    classifications[classification].examples.push({
                        query: query.length > 60 ? query.substring(0, 60) + '...' : query,
                        title: title.length > 80 ? title.substring(0, 80) + '...' : title
                    });
                }
            });

            return classifications;
        }

        // ИСПРАВЛЕННАЯ ФУНКЦИЯ КЛАССИФИКАЦИИ
        function classifyPage(url, title) {
            // Улучшенная логика классификации товарных страниц
            const titleLower = title.toLowerCase();
            
            // Признаки товарной страницы:
            const hasDetailedSpecs = /ду\s*\d+|dn\s*\d+|ру\s*\d+|pn\s*\d+|\d+\s*мм|\d+"|1\/2|3\/4/i.test(title);
            const hasModelNumber = /[A-Z0-9]{2,}[-\(\)A-Z0-9]*\d/i.test(title);
            const hasDetailedDescription = title.length > 50;
            const hasTechnicalTerms = /(нержавеющая|латунь|чугун|полнопроходной|фланцевый|муфтовый|резьбовой|привод|рычаг)/i.test(title);
            
            // Признаки листинга:
            const isCatalogPage = /(каталог|категория|все|подбор|выбор|серия|линейка)/i.test(title);
            const isBrandPage = /^[A-Z\s]+$/i.test(title.trim()) && title.length < 30;
            const isGenericTitle = title.length < 30 && !hasDetailedSpecs;
            
            // Логика принятия решения
            if (isCatalogPage || isBrandPage || isGenericTitle) {
                return 'listings';
            }
            
            if (hasDetailedSpecs && (hasModelNumber || hasTechnicalTerms) && hasDetailedDescription) {
                return 'products';
            }
            
            // По умолчанию относим к листингам
            return 'listings';
        }

        function startAnalysis() {
            if (!currentData) {
                showMessage('Данные не загружены', 'error');
                return;
            }

            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // Используем setTimeout для асинхронности
            setTimeout(() => {
                try {
                    analyzeData(currentData);
                } catch (error) {
                    console.error('Error in analysis:', error);
                    document.getElementById('loading').style.display = 'none';
                    showMessage(`Ошибка при анализе: ${error.message}`, 'error');
                }
            }, 500);
        }

        function analyzeData(data) {
            try {
                const rows = data.slice(1).filter(row => row && row[0] && row[3]);
                const sampleSize = Math.min(rows.length, processLimit);
                const sample = rows.slice(0, sampleSize);

                // Анализ характеристик
                const characteristicsAnalysis = analyzeCharacteristics(sample);

                // Результаты анализа
                const results = {
                    total: sampleSize,
                    products: [],
                    listings: [],
                    characteristics: characteristicsAnalysis
                };

                // Классификация и анализ релевантности
                sample.forEach(row => {
                    const query = row[0] || '';
                    const url = row[2] || '';
                    const title = row[3] || '';
                    
                    const classification = classifyPage(url, title);
                    const relevanceResult = analyzeRelevance(query, title, classification);
                    
                    results[classification].push({
                        query,
                        url,
                        title,
                        relevance: relevanceResult
                    });
                });

                displayResults(results);
            } catch (error) {
                console.error('Error in analyzeData:', error);
                document.getElementById('loading').style.display = 'none';
                showMessage(`Ошибка анализа данных: ${error.message}`, 'error');
            }
        }

        function analyzeCharacteristics(sample) {
            const characteristics = {};
            
            const patterns = [
                { pattern: /ду\s*(\d+)/gi, name: 'Диаметр ДУ', category: 'size' },
                { pattern: /dn\s*(\d+)/gi, name: 'Диаметр DN', category: 'size' },
                { pattern: /ру\s*(\d+)/gi, name: 'Давление РУ', category: 'pressure' },
                { pattern: /pn\s*(\d+)/gi, name: 'Давление PN', category: 'pressure' },
                { pattern: /(\d+)\s*мм/gi, name: 'Размер в мм', category: 'size' },
                { pattern: /латун/gi, name: 'Латунь', category: 'material' },
                { pattern: /нержав/gi, name: 'Нержавеющая сталь', category: 'material' },
                { pattern: /муфтов/gi, name: 'Муфтовое соединение', category: 'connection' },
                { pattern: /фланц/gi, name: 'Фланцевое соединение', category: 'connection' }
            ];
            
            sample.forEach(row => {
                if (!row || !row[0]) return;
                
                const query = row[0].toLowerCase();
                
                patterns.forEach(({ pattern, name, category }) => {
                    const regex = new RegExp(pattern.source, pattern.flags);
                    if (regex.test(query)) {
                        const key = `${category}_${name}`;
                        if (!characteristics[key]) {
                            characteristics[key] = {
                                name: name,
                                category: category,
                                count: 0,
                                total: sample.length
                            };
                        }
                        characteristics[key].count++;
                    }
                });
            });

            // Вычисление процентов
            Object.keys(characteristics).forEach(key => {
                characteristics[key].percentage = Math.round(
                    (characteristics[key].count / characteristics[key].total) * 100
                );
            });

            return characteristics;
        }

        function analyzeRelevance(query, title, pageType) {
            const queryInfo = extractInfo(query);
            const titleInfo = extractInfo(title);
            
            if (queryInfo.types.length === 0) {
                return { relevant: false, reason: 'Не определен тип товара в запросе' };
            }
            
            if (titleInfo.types.length === 0) {
                return { relevant: false, reason: 'Не определен тип товара в заголовке' };
            }
            
            if (!areTypesCompatible(queryInfo.types, titleInfo.types)) {
                return { relevant: false, reason: 'Несоответствие типа товара' };
            }
            
            return { relevant: true, reason: 'Соответствует критериям' };
        }

        function extractInfo(text) {
            const normalized = text.toLowerCase().replace(/[^\wа-я]/g, ' ').replace(/\s+/g, ' ').trim();
            let foundTypes = [];
            
            // Поиск технических кодов
            for (let [code, expansion] of Object.entries(TECHNICAL_ABBREVIATIONS)) {
                if (normalized.includes(code)) {
                    foundTypes.push(...expansion.split(' '));
                }
            }
            
            // Поиск типов товаров
            if (currentConfig.productTypes) {
                for (let type of currentConfig.productTypes) {
                    if (normalized.includes(type)) {
                        foundTypes.push(type);
                    }
                }
            }
            
            return { types: [...new Set(foundTypes)] };
        }

        function areTypesCompatible(queryTypes, titleTypes) {
            if (!queryTypes.length || !titleTypes.length) return false;
            
            // Прямое совпадение
            for (let qType of queryTypes) {
                if (titleTypes.includes(qType)) return true;
            }
            
            // Проверка синонимов
            if (currentConfig.synonymGroups) {
                for (let group of currentConfig.synonymGroups) {
                    let queryHas = queryTypes.some(t => group.includes(t));
                    let titleHas = titleTypes.some(t => group.includes(t));
                    if (queryHas && titleHas) return true;
                }
            }
            
            return false;
        }

        // ИСПРАВЛЕННАЯ ФУНКЦИЯ calculateOverallStats
        function calculateOverallStats(results) {
            const productRelevant = results.products.filter(item => item.relevance.relevant).length;
            const listingRelevant = results.listings.filter(item => item.relevance.relevant).length;
            
            // Весовые коэффициенты: товары 100%, листинги 50%
            const weightedTotal = results.products.length * 1.0 + results.listings.length * 0.5;
            const weightedRelevant = productRelevant * 1.0 + listingRelevant * 0.5;
            const overallPercentage = weightedTotal > 0 ? (weightedRelevant / weightedTotal * 100).toFixed(1) : 0;

            return {
                total: results.total,
                products: results.products.length,
                listings: results.listings.length,
                overallPercentage: overallPercentage
            };
        }

        function calculateStats(pageData) {
            if (!pageData || !Array.isArray(pageData)) {
                return { total: 0, relevant: 0, irrelevant: 0, percentage: 0, problems: {} };
            }

            const total = pageData.length;
            const relevant = pageData.filter(item => item.relevance && item.relevance.relevant).length;
            const percentage = total > 0 ? (relevant / total * 100).toFixed(1) : 0;
            
            const problems = {};
            pageData.filter(item => item.relevance && !item.relevance.relevant).forEach(item => {
                const reason = item.relevance.reason || 'Неизвестная причина';
                problems[reason] = (problems[reason] || 0) + 1;
            });

            return { total, relevant, irrelevant: total - relevant, percentage, problems };
        }

        function displayResults(results) {
            try {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';

                const productStats = calculateStats(results.products);
                const listingStats = calculateStats(results.listings);
                const overallStats = calculateOverallStats(results);

                // Общая статистика
                displayOverallStats(overallStats);
                
                // Таблица сравнения
                displayComparisonTable(productStats, listingStats);
                
                // Характеристики
                displayCharacteristicsImportance(results.characteristics);
                
                // Контент по табам
                displayTabContent(results, productStats, listingStats);

                showMessage('Анализ завершен успешно!', 'success');
            } catch (error) {
                console.error('Error in displayResults:', error);
                showMessage(`Ошибка при отображении результатов: ${error.message}`, 'error');
            }
        }

        function displayOverallStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card excellent">
                    <span class="stat-value">${stats.total}</span>
                    <div class="stat-label">Всего записей</div>
                </div>
                <div class="stat-card good">
                    <span class="stat-value">${stats.products}</span>
                    <div class="stat-label">Товарные страницы</div>
                </div>
                <div class="stat-card satisfactory">
                    <span class="stat-value">${stats.listings}</span>
                    <div class="stat-label">Страницы листинга</div>
                </div>
                <div class="stat-card poor">
                    <span class="stat-value">${stats.overallPercentage}%</span>
                    <div class="stat-label">Общая релевантность</div>
                </div>
            `;

            const qualityRating = document.getElementById('qualityRating');
            const percentage = parseFloat(stats.overallPercentage);
            let qualityClass, qualityText;
            
            if (percentage >= 90) {
                qualityClass = 'quality-excellent';
                qualityText = '🟢 ОТЛИЧНО';
            } else if (percentage >= 80) {
                qualityClass = 'quality-good';
                qualityText = '🟡 ХОРОШО';
            } else if (percentage >= 70) {
                qualityClass = 'quality-satisfactory';
                qualityText = '🟠 УДОВЛЕТВОРИТЕЛЬНО';
            } else {
                qualityClass = 'quality-poor';
                qualityText = '🔴 ТРЕБУЕТ ИСПРАВЛЕНИЯ';
            }
            
            qualityRating.className = `quality-rating ${qualityClass}`;
            qualityRating.innerHTML = `${qualityText}<br><span style="font-size: 1.2rem;">Общая релевантность: ${stats.overallPercentage}%</span>`;
        }

        function displayComparisonTable(productStats, listingStats) {
            const comparisonBody = document.getElementById('comparisonBody');
            
            const getTopProblems = (problems) => {
                if (!problems || typeof problems !== 'object') return 'Нет проблем';
                const sorted = Object.entries(problems).sort((a, b) => b[1] - a[1]);
                return sorted.slice(0, 2).map(([problem, count]) => `${problem} (${count})`).join(', ') || 'Нет проблем';
            };

            comparisonBody.innerHTML = `
                <tr>
                    <td><strong>Товарные страницы</strong></td>
                    <td>${productStats.total}</td>
                    <td><span style="color: ${productStats.percentage >= 80 ? '#38a169' : '#e53e3e'}">${productStats.percentage}%</span></td>
                    <td>${getTopProblems(productStats.problems)}</td>
                </tr>
                <tr>
                    <td><strong>Страницы листинга</strong></td>
                    <td>${listingStats.total}</td>
                    <td><span style="color: ${listingStats.percentage >= 70 ? '#38a169' : '#e53e3e'}">${listingStats.percentage}%</span></td>
                    <td>${getTopProblems(listingStats.problems)}</td>
                </tr>
            `;
        }

        function displayCharacteristicsImportance(characteristics) {
            const characteristicsGrid = document.getElementById('characteristicsGrid');
            
            const filteredChars = Object.entries(characteristics)
                .filter(([key, data]) => data.percentage >= 1)
                .sort((a, b) => b[1].percentage - a[1].percentage)
                .slice(0, 12);

            if (filteredChars.length === 0) {
                characteristicsGrid.innerHTML = '<p style="text-align: center; opacity: 0.7;">Характеристики не найдены</p>';
                return;
            }

            characteristicsGrid.innerHTML = filteredChars.map(([key, data]) => `
                <div class="characteristic-item">
                    <span class="characteristic-percentage">${data.percentage}%</span>
                    <div class="characteristic-label">${data.name}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">${data.count}/${data.total}</div>
                </div>
            `).join('');
        }

        function displayTabContent(results, productStats, listingStats) {
            // Товарные страницы
            const productsContent = document.getElementById('products-content');
            const productExamples = getExamples(results.products, 5);
            
            productsContent.innerHTML = `
                <h3 class="section-title">✅ Примеры хороших соответствий (${productExamples.good.length})</h3>
                ${productExamples.good.map(example => `
                    <div class="example-item good">
                        <div class="query"><strong>Запрос:</strong> ${example.query}</div>
                        <div class="title"><strong>Заголовок:</strong> ${example.title}</div>
                    </div>
                `).join('')}
                
                <h3 class="section-title">❌ Примеры проблемных случаев (${productExamples.bad.length})</h3>
                ${productExamples.bad.map(example => `
                    <div class="example-item bad">
                        <div class="query"><strong>Запрос:</strong> ${example.query}</div>
                        <div class="title"><strong>Заголовок:</strong> ${example.title}</div>
                        <div class="reason"><strong>Проблема:</strong> ${example.relevance.reason}</div>
                    </div>
                `).join('')}
            `;

            // Страницы листинга
            const listingsContent = document.getElementById('listings-content');
            const listingExamples = getExamples(results.listings, 5);
            
            listingsContent.innerHTML = `
                <p style="margin-bottom: 20px; color: #666;">Страницы каталогов, категорий и кратких описаний (вес 50%)</p>
                
                <h3 class="section-title">✅ Примеры хороших соответствий (${listingExamples.good.length})</h3>
                ${listingExamples.good.map(example => `
                    <div class="example-item good">
                        <div class="query"><strong>Запрос:</strong> ${example.query}</div>
                        <div class="title"><strong>Заголовок:</strong> ${example.title}</div>
                    </div>
                `).join('')}
                
                <h3 class="section-title">❌ Примеры проблемных случаев (${listingExamples.bad.length})</h3>
                ${listingExamples.bad.map(example => `
                    <div class="example-item bad">
                        <div class="query"><strong>Запрос:</strong> ${example.query}</div>
                        <div class="title"><strong>Заголовок:</strong> ${example.title}</div>
                        <div class="reason"><strong>Проблема:</strong> ${example.relevance.reason}</div>
                    </div>
                `).join('')}
            `;

            // Анализ проблем
            const problemsContent = document.getElementById('problems-content');
            const allProblems = { ...productStats.problems, ...listingStats.problems };
            
            problemsContent.innerHTML = `
                <h3 class="section-title">🔍 Основные типы проблем</h3>
                ${Object.entries(allProblems).sort((a, b) => b[1] - a[1]).map(([problem, count]) => `
                    <div class="example-item">
                        <div class="query"><strong>Проблема:</strong> ${problem}</div>
                        <div class="title"><strong>Количество случаев:</strong> ${count}</div>
                        <div style="color: #666; margin-top: 10px;">
                            ${getProblemsolution(problem)}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getProblemsolution(problem) {
            const solutions = {
                'Не определен тип товара в запросе': 'Рекомендуется расширить семантическое ядро с конкретными типами товаров',
                'Не определен тип товара в заголовке': 'Необходимо дополнить заголовки конкретными названиями товаров',
                'Несоответствие типа товара': 'Проверьте соответствие landing page запросам пользователей'
            };
            return solutions[problem] || 'Требуется индивидуальный анализ';
        }

        function getExamples(data, limit) {
            if (!data || !Array.isArray(data)) {
                return { good: [], bad: [] };
            }

            const good = data.filter(item => item.relevance && item.relevance.relevant).slice(0, limit);
            const bad = data.filter(item => item.relevance && !item.relevance.relevant).slice(0, limit);
            return { good, bad };
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        function exportToPdf() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('Анализ релевантности заголовков', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Категория: ${currentConfig.name}`, 20, 50);
                doc.text(`Дата анализа: ${new Date().toLocaleDateString('ru-RU')}`, 20, 60);
                
                const qualityElement = document.getElementById('qualityRating');
                if (qualityElement) {
                    const qualityText = qualityElement.textContent.replace(/\s+/g, ' ').trim();
                    doc.text(`Результат: ${qualityText}`, 20, 80);
                }
                
                doc.save(`relevance_analysis_${new Date().toISOString().split('T')[0]}.pdf`);
                showMessage('PDF-отчет экспортирован', 'success');
            } catch (error) {
                showMessage(`Ошибка экспорта PDF: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
