<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ 2.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .upload-section {
            padding: 40px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .setting-block {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }
        
        .setting-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }
        
        .category-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .category-option {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .category-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .category-option.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .limit-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .slider-value {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            margin-top: 5px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 auto;
            display: block;
            text-align: center;
            width: fit-content;
        }
        
        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .preview-section {
            padding: 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: none;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .preview-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .preview-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .preview-examples {
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            padding: 40px;
            display: none;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-card.excellent { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.good { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-card.satisfactory { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-card.poor { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }
        
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .comparison-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 30px 0;
        }
        
        .comparison-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .comparison-table tr:hover {
            background: #f8f9fa;
        }
        
        .characteristics-importance {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .characteristics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .characteristic-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: help;
        }
        
        .characteristic-percentage {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }
        
        .characteristic-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .quality-rating {
            text-align: center;
            padding: 25px;
            margin: 30px 0;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .quality-excellent { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2d3748; }
        .quality-good { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2d3748; }
        .quality-satisfactory { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; }
        .quality-poor { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #2d3748; }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .example-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .example-item.good {
            border-left-color: #38a169;
        }
        
        .example-item.bad {
            border-left-color: #e53e3e;
        }
        
        .query, .title {
            margin-bottom: 8px;
        }
        
        .query {
            font-weight: 600;
            color: #2d3748;
        }
        
        .title {
            color: #4a5568;
        }
        
        .reason {
            color: #e53e3e;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #e53e3e;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #2d5a27;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #38a169;
        }

        .valve-code-info {
            background: #e6f3ff;
            border: 1px solid #4facfe;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .valve-code-match {
            background: #e6ffe6;
            border-left: 4px solid #38a169;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version-badge">–í–µ—Ä—Å–∏—è 2.1 (—Å —Ç–∞–±–ª–∏—Ü–µ–π —Ñ–∏–≥—É—Ä)</div>
            <h1>üîç –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤</h1>
            <p>–ú–Ω–æ–≥–æ–∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç–∞–±–ª–∏—Ü—ã —Ñ–∏–≥—É—Ä –∑–∞–¥–≤–∏–∂–µ–∫</p>
        </div>
        
        <div class="upload-section">
            <div class="settings-grid">
                <div class="setting-block">
                    <div class="setting-title">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>
                    <div class="category-selector">
                        <div class="category-option active" data-category="klapany">–ö–ª–∞–ø–∞–Ω—ã</div>
                        <div class="category-option" data-category="krany">–ö—Ä–∞–Ω—ã</div>
                        <div class="category-option" data-category="zadvijki">–ó–∞–¥–≤–∏–∂–∫–∏</div>
                        <div class="category-option" data-category="auto">–ê–≤—Ç–æ</div>
                    </div>
                    <div class="valve-code-info" style="display: none;">
                        <strong>üìã –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü—ã —Ñ–∏–≥—É—Ä –∑–∞–¥–≤–∏–∂–µ–∫</strong><br>
                        –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ó–∞–¥–≤–∏–∂–∫–∏" —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–¥—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ì–û–°–¢:<br>
                        ‚Ä¢ –¢–∏–ø –∏–∑–¥–µ–ª–∏—è (30, 31)<br>
                        ‚Ä¢ –ú–∞—Ç–µ—Ä–∏–∞–ª –∫–æ—Ä–ø—É—Å–∞ (–ª—Å, —Å, –Ω–∂, —á, –±—Ä)<br>
                        ‚Ä¢ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π –Ω–æ–º–µ—Ä<br>
                        ‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è (–•–õ, –ì–ê–ó, –ú–ó–í)
                    </div>
                    <div id="craneTypeInfo" class="valve-code-info" style="display: none;">
                        <strong>üîß –ú–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–∞–Ω–æ–≤</strong><br>
                        –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ö—Ä–∞–Ω—ã" –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è:<br>
                        ‚Ä¢ –¢–∏–ø –∫—Ä–∞–Ω–∞ (—à–∞—Ä–æ–≤–æ–π, –ø—Ä–æ–±–∫–æ–≤—ã–π, –∏–≥–æ–ª—å—á–∞—Ç—ã–π) - 4 –±–∞–ª–ª–∞<br>
                        ‚Ä¢ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π, —Ç—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π) - 2 –±–∞–ª–ª–∞<br>
                        ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—Ä—É—á–Ω–æ–π, —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–≤–æ–¥, –ø–Ω–µ–≤–º–æ–ø—Ä–∏–≤–æ–¥) - 1 –±–∞–ª–ª<br>
                        ‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–î–£, –†–£, –º–∞—Ç–µ—Ä–∏–∞–ª, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
                    </div>
                </div>
                
                <div class="setting-block">
                    <div class="setting-title">üìä –õ–∏–º–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
                    <input type="range" class="limit-slider" min="100" max="10000" value="1000" step="100" id="limitSlider">
                    <div class="slider-value" id="sliderValue">1000 –∑–∞–ø–∏—Å–µ–π</div>
                </div>
            </div>
            
            <div class="file-input-wrapper">
                <input type="file" class="file-input" accept=".xlsx,.xls" id="fileInput">
                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª Excel
            </div>
            <p style="margin-top: 15px; text-align: center; color: #666;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã .xlsx –∏ .xls</p>
            
            <div id="messageArea"></div>
        </div>
        
        <div class="preview-section" id="previewSection">
            <h3 class="section-title">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
            <div class="preview-grid" id="previewGrid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="export-btn" id="startAnalysis">üöÄ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...</p>
        </div>
        
        <div class="results" id="results">
            <div class="results-header">
                <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>
                <button class="export-btn" id="exportPdf">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
            </div>
            
            <div class="stats-grid" id="statsGrid"></div>
            <div class="quality-rating" id="qualityRating"></div>
            
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>–¢–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å</th>
                            <th>–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody"></tbody>
                </table>
            </div>
            
            <div class="characteristics-importance">
                <h3>üéØ –í–∞–∂–Ω–æ—Å—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö</h3>
                <p>–ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —É–ø–æ–º–∏–Ω–∞–µ–º—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</p>
                <div class="characteristics-grid" id="characteristicsGrid"></div>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="products">–¢–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</button>
                <button class="tab" data-tab="listings">–°—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∏–Ω–≥–∞</button>
                <button class="tab" data-tab="problems">–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º</button>
            </div>
            
            <div class="tab-content active" id="products-content"></div>
            <div class="tab-content" id="listings-content"></div>
            <div class="tab-content" id="problems-content"></div>
        </div>
    </div>

    <script>
        // –î–û–†–ê–ë–û–¢–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ü–û–î–î–ï–†–ñ–ö–û–ô –¢–ê–ë–õ–ò–¶–´ –§–ò–ì–£–† –ó–ê–î–í–ò–ñ–ï–ö
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
        const TECHNICAL_ABBREVIATIONS = {
            '–∫—à': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π',
            '–∫—à–º': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π –º—É—Ñ—Ç–æ–≤—ã–π',
            '–∫—à—Ñ': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π —Ñ–ª–∞–Ω—Ü–µ–≤—ã–π',
            '–∫—à—Ç': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π —Ç—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π',
            '–∫—à–ø': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π —Å –ø–Ω–µ–≤–º–æ–ø—Ä–∏–≤–æ–¥–æ–º',
            '–∫—à—ç': '–∫—Ä–∞–Ω —à–∞—Ä–æ–≤–æ–π —Å —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–≤–æ–¥–æ–º',
            '–∫–æ': '–∫–ª–∞–ø–∞–Ω –æ–±—Ä–∞—Ç–Ω—ã–π',
            '–∫–±': '–∫–ª–∞–ø–∞–Ω –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–æ—á–Ω—ã–π',
            '–∫–ø': '–∫–ª–∞–ø–∞–Ω –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω—ã–π',
            '–∫—Ä': '–∫–ª–∞–ø–∞–Ω —Ä–µ–≥—É–ª–∏—Ä—É—é—â–∏–π',
            '–∑–∫': '–∑–∞–¥–≤–∏–∂–∫–∞ –∫–ª–∏–Ω–æ–≤–∞—è',
            '–∑—à': '–∑–∞–¥–≤–∏–∂–∫–∞ —à–∏–±–µ—Ä–Ω–∞—è'
        };

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Ñ–∏–≥—É—Ä –∑–∞–¥–≤–∏–∂–µ–∫
        const VALVE_CODES = {
            // –¢–∏–ø—ã –∏–∑–¥–µ–ª–∏–π
            types: {
                '30': '–∑–∞–¥–≤–∏–∂–∫–∞ –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è',
                '31': '–∑–∞–¥–≤–∏–∂–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è'
            },
            // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫–æ—Ä–ø—É—Å–∞
            materials: {
                '–ª—Å': '–ª–∏—Ç–∞—è —Å—Ç–∞–ª—å',
                '—Å': '—Å—Ç–∞–ª—å',
                '–Ω–∂': '–Ω–µ—Ä–∂–∞–≤–µ—é—â–∞—è —Å—Ç–∞–ª—å',
                '–ª—Å–Ω–∂': '–ª–∏—Ç–∞—è –Ω–µ—Ä–∂–∞–≤–µ—é—â–∞—è —Å—Ç–∞–ª—å',
                '—á': '—á—É–≥—É–Ω',
                '–±—Ä': '–±—Ä–æ–Ω–∑–∞'
            },
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è
            modifiers: {
                '—Ö–ª': '—Ö–æ–ª–æ–¥–Ω—ã–π –∫–ª–∏–º–∞—Ç',
                '–≥–∞–∑': '–¥–ª—è –≥–∞–∑–∞',
                '–º–∑–≤': '–≤—ã–¥–≤–∏–∂–Ω–æ–π —à–ø–∏–Ω–¥–µ–ª—å',
                '–º–∑–≤–≥': '–≤—ã–¥–≤–∏–∂–Ω–æ–π —à–ø–∏–Ω–¥–µ–ª—å –¥–ª—è –≥–∞–∑–∞'
            }
        };

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const CONFIG = {
            klapany: {
                name: '–ö–ª–∞–ø–∞–Ω—ã',
                productTypes: ['–∫–ª–∞–ø–∞–Ω', '–≤–µ–Ω—Ç–∏–ª—å', '–æ–±—Ä–∞—Ç–Ω—ã–π', '–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–æ—á–Ω—ã–π', '–ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω—ã–π', '—Ä–µ–≥—É–ª–∏—Ä—É—é—â–∏–π'],
                synonymGroups: [
                    ['–∫–ª–∞–ø–∞–Ω', '–≤–µ–Ω—Ç–∏–ª—å'],
                    ['–æ–±—Ä–∞—Ç–Ω—ã–π', '–Ω–µ–≤–æ–∑–≤—Ä–∞—Ç–Ω—ã–π'],
                    ['–º—É—Ñ—Ç–æ–≤—ã–π', '—Ä–µ–∑—å–±–æ–≤–æ–π']
                ],
                technicalCodes: ['–∫–æ', '–∫–±', '–∫–ø', '–∫—Ä']
            },
            krany: {
                name: '–ö—Ä–∞–Ω—ã',
                productTypes: ['–∫—Ä–∞–Ω', '—à–∞—Ä–æ–≤–æ–π', '–ø—Ä–æ–±–∫–æ–≤—ã–π', '–∏–≥–æ–ª—å—á–∞—Ç—ã–π'],
                synonymGroups: [
                    ['–∫—Ä–∞–Ω', '—à–∞—Ä–æ–≤–æ–π –∫—Ä–∞–Ω'],
                    ['–ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π', '–ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ö–æ–¥'],
                    ['—Ç—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π', '3-—Ö —Ö–æ–¥–æ–≤–æ–π']
                ],
                technicalCodes: ['–∫—à', '–∫—à–º', '–∫—à—Ñ', '–∫—à—Ç', '–∫—à–ø', '–∫—à—ç']
            },
            zadvijki: {
                name: '–ó–∞–¥–≤–∏–∂–∫–∏',
                productTypes: ['–∑–∞–¥–≤–∏–∂–∫–∞', '–∫–ª–∏–Ω–æ–≤–∞—è', '—à–∏–±–µ—Ä–Ω–∞—è', '–¥–∏—Å–∫–æ–≤–∞—è'],
                synonymGroups: [
                    ['—à–∏–±–µ—Ä–Ω–∞—è', '–Ω–æ–∂–µ–≤–∞—è'],
                    ['–≤—ã–¥–≤–∏–∂–Ω–æ–π', '–≤—ã–¥–≤–∏–∂–Ω–æ–π —à–ø–∏–Ω–¥–µ–ª—å'],
                    ['–∫–ª–∏–Ω–æ–≤–∞—è', '–∫–ª–∏–Ω']
                ],
                technicalCodes: ['–∑–∫', '–∑—à'],
                useValveCodes: true // –§–ª–∞–≥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Ñ–∏–≥—É—Ä
            },
            auto: {
                name: '–ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ',
                productTypes: [],
                synonymGroups: [],
                technicalCodes: []
            }
        };

        let currentData = null;
        let currentConfig = CONFIG.klapany;
        let processLimit = 1000;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initializeInterface();
        });

        function initializeInterface() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            document.querySelectorAll('.category-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.category-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    const category = this.dataset.category;
                    currentConfig = CONFIG[category];
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ
                    const valveInfo = document.getElementById('valveCodeInfo');
                    const craneInfo = document.getElementById('craneTypeInfo');
                    
                    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏
                    if (valveInfo) valveInfo.style.display = 'none';
                    if (craneInfo) craneInfo.style.display = 'none';
                    
                    if (category === 'zadvijki') {
                        if (valveInfo) valveInfo.style.display = 'block';
                    } else if (category === 'krany') {
                        if (craneInfo) craneInfo.style.display = 'block';
                    }
                    
                    showMessage(`–í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${currentConfig.name}`, 'success');
                });
            });

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–∞–π–¥–µ—Ä–∞
            const slider = document.getElementById('limitSlider');
            const sliderValue = document.getElementById('sliderValue');
            
            slider.addEventListener('input', function() {
                processLimit = parseInt(this.value);
                sliderValue.textContent = `${processLimit} –∑–∞–ø–∏—Å–µ–π`;
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('startAnalysis').addEventListener('click', startAnalysis);
            document.getElementById('exportPdf').addEventListener('click', exportToPdf);

            // –¢–∞–±—ã
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
        }

        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'error' ? 'error-message' : 'success-message';
            messageArea.innerHTML = `<div class="${className}">${text}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showMessage(`–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ñ–∞–π–ª: ${file.name}`, 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏—Å—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö');
                    }
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (!jsonData || jsonData.length < 2) {
                        throw new Error('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å—Ç—Ä–æ–∫–∏ (–∑–∞–≥–æ–ª–æ–≤–∫–∏ + –¥–∞–Ω–Ω—ã–µ)');
                    }
                    
                    const headers = jsonData[0];
                    if (!headers || headers.length < 4) {
                        throw new Error('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 –∫–æ–ª–æ–Ω–∫–∏: –∑–∞–ø—Ä–æ—Å, –∫–∞–º–ø–∞–Ω–∏—è, url, title');
                    }
                    
                    currentData = jsonData;
                    showMessage(`–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω: ${jsonData.length - 1} –∑–∞–ø–∏—Å–µ–π`, 'success');
                    showPreview(jsonData);
                } catch (error) {
                    console.error('Error processing file:', error);
                    showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function showPreview(data) {
            try {
                const rows = data.slice(1).filter(row => row && row[0] && row[3]);
                
                if (rows.length === 0) {
                    showMessage('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏', 'error');
                    return;
                }

                const sample = rows.slice(0, 50);
                const preview = classifyPreview(sample);
                
                const previewGrid = document.getElementById('previewGrid');
                previewGrid.innerHTML = `
                    <div class="preview-card">
                        <div class="preview-title">üõí –¢–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (${preview.products.count})</div>
                        <div class="preview-examples">
                            <div style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                –°—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
                            </div>
                            ${preview.products.examples.slice(0, 3).map(ex => 
                                `<div style="margin: 8px 0; padding: 8px; background: #f0f8f0; border-radius: 4px; font-size: 0.8rem;">
                                    <strong>–ó–∞–ø—Ä–æ—Å:</strong> ${ex.query}<br>
                                    <strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${ex.title}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="preview-card">
                        <div class="preview-title">üìã –°—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∏–Ω–≥–∞ (${preview.listings.count})</div>
                        <div class="preview-examples">
                            <div style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                –ö–∞—Ç–∞–ª–æ–≥–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫—Ä–∞—Ç–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
                            </div>
                            ${preview.listings.examples.slice(0, 3).map(ex => 
                                `<div style="margin: 8px 0; padding: 8px; background: #f8f0f0; border-radius: 4px; font-size: 0.8rem;">
                                    <strong>–ó–∞–ø—Ä–æ—Å:</strong> ${ex.query}<br>
                                    <strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${ex.title}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('previewSection').style.display = 'block';
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ${error.message}`, 'error');
            }
        }

        function classifyPreview(sample) {
            const classifications = {
                products: { count: 0, examples: [] },
                listings: { count: 0, examples: [] }
            };

            sample.forEach(row => {
                if (!row || !Array.isArray(row)) return;

                const query = row[0] || '';
                const url = row[2] || '';
                const title = row[3] || '';
                
                const classification = classifyPage(url, title);
                classifications[classification].count++;
                
                if (classifications[classification].examples.length < 5) {
                    classifications[classification].examples.push({
                        query: query.length > 60 ? query.substring(0, 60) + '...' : query,
                        title: title.length > 80 ? title.substring(0, 80) + '...' : title
                    });
                }
            });

            return classifications;
        }

        function classifyPage(url, title) {
            const titleLower = title.toLowerCase();
            
            const hasDetailedSpecs = /–¥—É\s*\d+|dn\s*\d+|—Ä—É\s*\d+|pn\s*\d+|\d+\s*–º–º|\d+"|1\/2|3\/4/i.test(title);
            const hasModelNumber = /[A-Z0-9]{2,}[-\(\)A-Z0-9]*\d/i.test(title);
            const hasDetailedDescription = title.length > 50;
            const hasTechnicalTerms = /(–Ω–µ—Ä–∂–∞–≤–µ—é—â–∞—è|–ª–∞—Ç—É–Ω—å|—á—É–≥—É–Ω|–ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π|—Ñ–ª–∞–Ω—Ü–µ–≤—ã–π|–º—É—Ñ—Ç–æ–≤—ã–π|—Ä–µ–∑—å–±–æ–≤–æ–π|–ø—Ä–∏–≤–æ–¥|—Ä—ã—á–∞–≥)/i.test(title);
            
            const isCatalogPage = /(–∫–∞—Ç–∞–ª–æ–≥|–∫–∞—Ç–µ–≥–æ—Ä–∏—è|–≤—Å–µ|–ø–æ–¥–±–æ—Ä|–≤—ã–±–æ—Ä|—Å–µ—Ä–∏—è|–ª–∏–Ω–µ–π–∫–∞)/i.test(title);
            const isBrandPage = /^[A-Z\s]+$/i.test(title.trim()) && title.length < 30;
            const isGenericTitle = title.length < 30 && !hasDetailedSpecs;
            
            if (isCatalogPage || isBrandPage || isGenericTitle) {
                return 'listings';
            }
            
            if (hasDetailedSpecs && (hasModelNumber || hasTechnicalTerms) && hasDetailedDescription) {
                return 'products';
            }
            
            return 'listings';
        }

        function startAnalysis() {
            if (!currentData) {
                showMessage('–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'error');
                return;
            }

            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            setTimeout(() => {
                try {
                    analyzeData(currentData);
                } catch (error) {
                    console.error('Error in analysis:', error);
                    document.getElementById('loading').style.display = 'none';
                    showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: ${error.message}`, 'error');
                }
            }, 500);
        }

        function analyzeData(data) {
            try {
                const rows = data.slice(1).filter(row => row && row[0] && row[3]);
                const sampleSize = Math.min(rows.length, processLimit);
                const sample = rows.slice(0, sampleSize);

                const characteristicsAnalysis = analyzeCharacteristics(sample);

                const results = {
                    total: sampleSize,
                    products: [],
                    listings: [],
                    characteristics: characteristicsAnalysis
                };

                sample.forEach(row => {
                    const query = row[0] || '';
                    const url = row[2] || '';
                    const title = row[3] || '';
                    
                    const classification = classifyPage(url, title);
                    const relevanceResult = analyzeRelevance(query, title, classification);
                    
                    results[classification].push({
                        query,
                        url,
                        title,
                        relevance: relevanceResult
                    });
                });

                displayResults(results);
            } catch (error) {
                console.error('Error in analyzeData:', error);
                document.getElementById('loading').style.display = 'none';
                showMessage(`–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
            }
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–¥–∞ –∑–∞–¥–≤–∏–∂–∫–∏
        function parseValveCode(text) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤ —Å–∫–æ–±–∫–∞—Ö –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
            const cleanText = text.replace(/\([^)]*\)/g, '').trim().toLowerCase();
            
            // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω: —Ü–∏—Ñ—Ä—ã + –±—É–∫–≤—ã + —Ü–∏—Ñ—Ä—ã + –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
            const valvePattern = /(\d{2,3})([–∞-—è]+)(\d+)([–∞-—è]*)/g;
            const matches = [...cleanText.matchAll(valvePattern)];
            
            const codes = [];
            
            matches.forEach(match => {
                const [fullMatch, typeCode, materialCode, constructiveNumber, modifiers] = match;
                
                const parsed = {
                    original: fullMatch,
                    type: typeCode,
                    material: materialCode,
                    constructiveNumber: constructiveNumber,
                    modifiers: modifiers || '',
                    normalized: `${typeCode}${materialCode}${constructiveNumber}${modifiers}`
                };
                
                codes.push(parsed);
            });
            
            return codes;
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∫–æ–¥–æ–≤ –∑–∞–¥–≤–∏–∂–µ–∫
        function compareValveCodes(queryCode, titleCode) {
            const queryParsed = parseValveCode(queryCode);
            const titleParsed = parseValveCode(titleCode);
            
            if (queryParsed.length === 0 || titleParsed.length === 0) {
                return { match: false, details: '–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–¥—ã' };
            }
            
            // –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–µ–∂–¥—É –ª—é–±—ã–º–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏
            for (let qCode of queryParsed) {
                for (let tCode of titleParsed) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
                    if (qCode.normalized === tCode.normalized) {
                        return {
                            match: true,
                            details: `–¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${qCode.original}`,
                            queryCode: qCode,
                            titleCode: tCode
                        };
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—Ç–∏–ø + –º–∞—Ç–µ—Ä–∏–∞–ª + –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤)
                    if (qCode.type === tCode.type && 
                        qCode.material === tCode.material && 
                        qCode.constructiveNumber === tCode.constructiveNumber) {
                        return {
                            match: true,
                            details: `–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: ${qCode.type}${qCode.material}${qCode.constructiveNumber}`,
                            queryCode: qCode,
                            titleCode: tCode
                        };
                    }
                }
            }
            
            return {
                match: false,
                details: `–ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∫–æ–¥–æ–≤: –∑–∞–ø—Ä–æ—Å ${queryParsed.map(c => c.original).join(', ')}, –∑–∞–≥–æ–ª–æ–≤–æ–∫ ${titleParsed.map(c => c.original).join(', ')}`,
                queryParsed,
                titleParsed
            };
        }

        function analyzeCharacteristics(sample) {
            const characteristics = {};
            
            let patterns = [
                { pattern: /–¥—É\s*(\d+)/gi, name: '–î–∏–∞–º–µ—Ç—Ä –î–£', category: 'size' },
                { pattern: /dn\s*(\d+)/gi, name: '–î–∏–∞–º–µ—Ç—Ä DN', category: 'size' },
                { pattern: /—Ä—É\s*(\d+)/gi, name: '–î–∞–≤–ª–µ–Ω–∏–µ –†–£', category: 'pressure' },
                { pattern: /pn\s*(\d+)/gi, name: '–î–∞–≤–ª–µ–Ω–∏–µ PN', category: 'pressure' },
                { pattern: /(\d+)\s*–º–º/gi, name: '–†–∞–∑–º–µ—Ä –≤ –º–º', category: 'size' },
                { pattern: /–ª–∞—Ç—É–Ω/gi, name: '–õ–∞—Ç—É–Ω—å', category: 'material' },
                { pattern: /–Ω–µ—Ä–∂–∞–≤/gi, name: '–ù–µ—Ä–∂–∞–≤–µ—é—â–∞—è —Å—Ç–∞–ª—å', category: 'material' },
                { pattern: /–º—É—Ñ—Ç–æ–≤/gi, name: '–ú—É—Ñ—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', category: 'connection' },
                { pattern: /—Ñ–ª–∞–Ω—Ü/gi, name: '–§–ª–∞–Ω—Ü–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', category: 'connection' }
            ];

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∑–∞–¥–≤–∏–∂–µ–∫
            if (currentConfig.useValveCodes) {
                patterns.push(
                    { pattern: /30[–∞-—è]+\d+/gi, name: '–ö–æ–¥ –∑–∞–¥–≤–∏–∂–∫–∏ —Ç–∏–ø 30', category: 'valve_code' },
                    { pattern: /31[–∞-—è]+\d+/gi, name: '–ö–æ–¥ –∑–∞–¥–≤–∏–∂–∫–∏ —Ç–∏–ø 31', category: 'valve_code' },
                    { pattern: /–∫–ª–∏–Ω–æ–≤/gi, name: '–ö–ª–∏–Ω–æ–≤–∞—è –∑–∞–¥–≤–∏–∂–∫–∞', category: 'valve_type' },
                    { pattern: /—à–∏–±–µ—Ä/gi, name: '–®–∏–±–µ—Ä–Ω–∞—è –∑–∞–¥–≤–∏–∂–∫–∞', category: 'valve_type' }
                );
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∫—Ä–∞–Ω–æ–≤
            if (currentConfig.name === '–ö—Ä–∞–Ω—ã') {
                patterns.push(
                    { pattern: /—à–∞—Ä–æ–≤/gi, name: '–®–∞—Ä–æ–≤–æ–π –∫—Ä–∞–Ω', category: 'crane_type' },
                    { pattern: /–ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω/gi, name: '–ü–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π', category: 'crane_design' },
                    { pattern: /—Ç—Ä–µ—Ö—Ö–æ–¥–æ–≤/gi, name: '–¢—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π', category: 'crane_design' },
                    { pattern: /—ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–≤–æ–¥/gi, name: '–≠–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–≤–æ–¥', category: 'crane_control' },
                    { pattern: /–ø–Ω–µ–≤–º–æ–ø—Ä–∏–≤–æ–¥/gi, name: '–ü–Ω–µ–≤–º–æ–ø—Ä–∏–≤–æ–¥', category: 'crane_control' },
                    { pattern: /—Ä—ã—á–∞–≥/gi, name: '–†—É—á–Ω–æ–π (—Ä—ã—á–∞–≥)', category: 'crane_control' }
                );
            }
            
            sample.forEach(row => {
                if (!row || !row[0]) return;
                
                const query = row[0].toLowerCase();
                
                patterns.forEach(({ pattern, name, category }) => {
                    const regex = new RegExp(pattern.source, pattern.flags);
                    if (regex.test(query)) {
                        const key = `${category}_${name}`;
                        if (!characteristics[key]) {
                            characteristics[key] = {
                                name: name,
                                category: category,
                                count: 0,
                                total: sample.length
                            };
                        }
                        characteristics[key].count++;
                    }
                });
            });

            Object.keys(characteristics).forEach(key => {
                characteristics[key].percentage = Math.round(
                    (characteristics[key].count / characteristics[key].total) * 100
                );
            });

            return characteristics;
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –∫—Ä–∞–Ω–æ–≤
        function extractValveTypes(text) {
            const types = [];
            const textLower = text.toLowerCase();
            
            // –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –∫—Ä–∞–Ω–æ–≤
            if (/—à–∞—Ä–æ–≤/i.test(text)) types.push('—à–∞—Ä–æ–≤–æ–π');
            if (/–ø—Ä–æ–±–∫–æ–≤/i.test(text)) types.push('–ø—Ä–æ–±–∫–æ–≤—ã–π');
            if (/–∏–≥–æ–ª—å—á–∞—Ç/i.test(text)) types.push('–∏–≥–æ–ª—å—á–∞—Ç—ã–π');
            if (/–≥–∞–∑–æ–≤/i.test(text)) types.push('–≥–∞–∑–æ–≤—ã–π');
            
            // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
            if (/–ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω/i.test(text) || /–ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ö–æ–¥/i.test(text)) types.push('–ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π');
            if (/—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω/i.test(text) || /—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ö–æ–¥/i.test(text)) types.push('—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π');
            if (/—Ç—Ä–µ—Ö—Ö–æ–¥–æ–≤/i.test(text) || /3-?—Ö?\s*—Ö–æ–¥–æ–≤/i.test(text)) types.push('—Ç—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π');
            if (/—á–µ—Ç—ã—Ä–µ—Ö—Ö–æ–¥–æ–≤/i.test(text) || /4-?—Ö?\s*—Ö–æ–¥–æ–≤/i.test(text)) types.push('—á–µ—Ç—ã—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π');
            
            // –¢–∏–ø—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (/—Ä—É—á–Ω/i.test(text) || /—à—Ç—É—Ä–≤–∞–ª/i.test(text) || /—Ä—ã—á–∞–≥/i.test(text)) types.push('—Ä—É—á–Ω–æ–π');
            if (/—ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–≤–æ–¥/i.test(text) || /—ç–ª–µ–∫—Ç—Ä–æ/i.test(text)) types.push('—Å —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–≤–æ–¥–æ–º');
            if (/–ø–Ω–µ–≤–º–æ–ø—Ä–∏–≤–æ–¥/i.test(text) || /–ø–Ω–µ–≤–º–æ/i.test(text)) types.push('—Å –ø–Ω–µ–≤–º–æ–ø—Ä–∏–≤–æ–¥–æ–º');
            
            return [...new Set(types)];
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –∫—Ä–∞–Ω–æ–≤
        function compareValveTypes(queryTypes, titleTypes) {
            const compatibility = {
                score: 0,
                maxScore: 0,
                details: []
            };

            if (queryTypes.length === 0) return compatibility;

            // –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –∫—Ä–∞–Ω–æ–≤ (–≤—ã—Å–æ–∫–∏–π –≤–µ—Å: 4 –±–∞–ª–ª–∞)
            const mainTypes = ['—à–∞—Ä–æ–≤–æ–π', '–ø—Ä–æ–±–∫–æ–≤—ã–π', '–∏–≥–æ–ª—å—á–∞—Ç—ã–π', '–≥–∞–∑–æ–≤—ã–π'];
            const queryMainTypes = queryTypes.filter(t => mainTypes.includes(t));
            const titleMainTypes = titleTypes.filter(t => mainTypes.includes(t));
            
            if (queryMainTypes.length > 0) {
                compatibility.maxScore += 4;
                const mainTypeMatch = queryMainTypes.some(qt => titleMainTypes.includes(qt));
                if (mainTypeMatch) {
                    compatibility.score += 4;
                    compatibility.details.push(`‚úÖ –¢–∏–ø –∫—Ä–∞–Ω–∞: ${queryMainTypes.join(', ')} —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ${titleMainTypes.join(', ')}`);
                } else if (titleMainTypes.length > 0) {
                    compatibility.details.push(`‚ùå –¢–∏–ø –∫—Ä–∞–Ω–∞: ${queryMainTypes.join(', ')} ‚â† ${titleMainTypes.join(', ')}`);
                }
            }

            // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (—Å—Ä–µ–¥–Ω–∏–π –≤–µ—Å: 2 –±–∞–ª–ª–∞)
            const designTypes = ['–ø–æ–ª–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π', '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–π', '—Ç—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π', '—á–µ—Ç—ã—Ä–µ—Ö—Ö–æ–¥–æ–≤–æ–π'];
            const queryDesignTypes = queryTypes.filter(t => designTypes.includes(t));
            const titleDesignTypes = titleTypes.filter(t => designTypes.includes(t));
            
            if (queryDesignTypes.length > 0) {
                compatibility.maxScore += 2;
                const designMatch = queryDesignTypes.some(qt => titleDesignTypes.includes(qt));
                if (designMatch) {
                    compatibility.score += 2;
                    compatibility.details.push(`‚úÖ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: ${queryDesignTypes.join(', ')} —Å–æ–≤–ø–∞–¥–∞–µ—Ç`);
                } else if (titleDesignTypes.length > 0) {
                    compatibility.details.push(`‚ùå –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: ${queryDesignTypes.join(', ')} ‚â† ${titleDesignTypes.join(', ')}`);
                }
            }

            // –¢–∏–ø—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∏–∑–∫–∏–π –≤–µ—Å: 1 –±–∞–ª–ª)
            const controlTypes = ['—Ä—É—á–Ω–æ–π', '—Å —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–≤–æ–¥–æ–º', '—Å –ø–Ω–µ–≤–º–æ–ø—Ä–∏–≤–æ–¥–æ–º'];
            const queryControlTypes = queryTypes.filter(t => controlTypes.includes(t));
            const titleControlTypes = titleTypes.filter(t => controlTypes.includes(t));
            
            if (queryControlTypes.length > 0) {
                compatibility.maxScore += 1;
                const controlMatch = queryControlTypes.some(qt => titleControlTypes.includes(qt));
                if (controlMatch) {
                    compatibility.score += 1;
                    compatibility.details.push(`‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${queryControlTypes.join(', ')} —Å–æ–≤–ø–∞–¥–∞–µ—Ç`);
                } else if (titleControlTypes.length > 0) {
                    compatibility.details.push(`‚ùå –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${queryControlTypes.join(', ')} ‚â† ${titleControlTypes.join(', ')}`);
                }
            }

            return compatibility;
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –∫—Ä–∞–Ω–æ–≤
        function analyzeCraneRelevance(query, title, pageType) {
            const queryLower = query.toLowerCase();
            const titleLower = title.toLowerCase();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–ª–æ–≤–∞ "–∫—Ä–∞–Ω" –≤ –∑–∞–ø—Ä–æ—Å–µ –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            const hasCraneInQuery = /–∫—Ä–∞–Ω/i.test(query);
            const hasCraneInTitle = /–∫—Ä–∞–Ω/i.test(title);
            
            if (!hasCraneInQuery && !hasCraneInTitle) {
                return { relevant: false, reason: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "–∫—Ä–∞–Ω"' };
            }

            // 1. –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const queryParams = extractTechnicalParams(query);
            const titleParams = extractTechnicalParams(title);
            const paramCompatibility = compareTechnicalParams(queryParams, titleParams);

            // 2. –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–∏–ø—ã –∫—Ä–∞–Ω–æ–≤
            const queryTypes = extractValveTypes(query);
            const titleTypes = extractValveTypes(title);
            const typeCompatibility = compareValveTypes(queryTypes, titleTypes);

            // 3. –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ—Ü–µ–Ω–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ —Ç–∏–ø–æ–≤
            const totalScore = paramCompatibility.score + typeCompatibility.score;
            const totalMaxScore = paramCompatibility.maxScore + typeCompatibility.maxScore;
            const allDetails = [...paramCompatibility.details, ...typeCompatibility.details];

            // 4. –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è
            if (totalMaxScore === 0) {
                // –ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è - –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                const queryInfo = extractInfo(query);
                const titleInfo = extractInfo(title);
                
                if (queryInfo.types.length > 0 && titleInfo.types.length > 0) {
                    if (areTypesCompatible(queryInfo.types, titleInfo.types)) {
                        return { 
                            relevant: true, 
                            reason: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∞–∑–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –∫—Ä–∞–Ω–æ–≤',
                            paramDetails: { score: 0, maxScore: 0, details: allDetails },
                            typeDetails: typeCompatibility
                        };
                    }
                }
                
                if (hasCraneInQuery && hasCraneInTitle) {
                    return { 
                        relevant: true, 
                        reason: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫—Ä–∞–Ω–∞ –±–µ–∑ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤',
                        paramDetails: paramCompatibility,
                        typeDetails: typeCompatibility
                    };
                }
                
                return { 
                    relevant: false, 
                    reason: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è',
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            }

            const compatibilityPercent = (totalScore / totalMaxScore) * 100;
            
            if (compatibilityPercent >= 90) {
                return { 
                    relevant: true, 
                    reason: `–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (${totalScore}/${totalMaxScore} - ${compatibilityPercent.toFixed(1)}%)`,
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            } else if (compatibilityPercent >= 70) {
                return { 
                    relevant: true, 
                    reason: `–•–æ—Ä–æ—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (${totalScore}/${totalMaxScore} - ${compatibilityPercent.toFixed(1)}%)`,
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            } else if (compatibilityPercent >= 50) {
                return { 
                    relevant: true, 
                    reason: `–ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (${totalScore}/${totalMaxScore} - ${compatibilityPercent.toFixed(1)}%)`,
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            } else {
                return { 
                    relevant: false, 
                    reason: `–ù–∏–∑–∫–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (${totalScore}/${totalMaxScore} - ${compatibilityPercent.toFixed(1)}%)`,
                    paramDetails: paramCompatibility,
                    typeDetails: typeCompatibility
                };
            }
        }

        // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function analyzeRelevance(query, title, pageType) {
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∑–∞–¥–≤–∏–∂–µ–∫
            if (currentConfig.useValveCodes) {
                return analyzeValveRelevance(query, title, pageType);
            }
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫—Ä–∞–Ω–æ–≤
            if (currentConfig.name === '–ö—Ä–∞–Ω—ã') {
                return analyzeCraneRelevance(query, title, pageType);
            }
            
            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–ª–∞–ø–∞–Ω–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const queryInfo = extractInfo(query);
            const titleInfo = extractInfo(title);
            
            if (queryInfo.types.length === 0) {
                return { relevant: false, reason: '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ' };
            }
            
            if (titleInfo.types.length === 0) {
                return { relevant: false, reason: '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ' };
            }
            
            if (!areTypesCompatible(queryInfo.types, titleInfo.types)) {
                return { relevant: false, reason: '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞' };
            }
            
            return { relevant: true, reason: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º' };
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        function extractTechnicalParams(text) {
            const params = {
                diameters: [],
                pressures: [],
                materials: [],
                connections: [],
                temperatures: []
            };

            // –î–∏–∞–º–µ—Ç—Ä—ã
            const duMatches = [...text.matchAll(/–¥—É\s*(\d+)/gi)];
            const dnMatches = [...text.matchAll(/dn\s*(\d+)/gi)];
            params.diameters = [...duMatches, ...dnMatches].map(m => parseInt(m[1]));

            // –î–∞–≤–ª–µ–Ω–∏—è
            const ruMatches = [...text.matchAll(/—Ä—É\s*(\d+)/gi)];
            const pnMatches = [...text.matchAll(/pn\s*(\d+)/gi)];
            params.pressures = [...ruMatches, ...pnMatches].map(m => parseInt(m[1]));

            // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
            if (/–Ω–µ—Ä–∂–∞–≤/i.test(text)) params.materials.push('–Ω–µ—Ä–∂–∞–≤–µ—é—â–∞—è');
            if (/–ª–∞—Ç—É–Ω/i.test(text)) params.materials.push('–ª–∞—Ç—É–Ω—å');
            if (/—á—É–≥—É–Ω/i.test(text)) params.materials.push('—á—É–≥—É–Ω');
            if (/—Å—Ç–∞–ª—å/i.test(text) && !/–Ω–µ—Ä–∂–∞–≤/i.test(text)) params.materials.push('—Å—Ç–∞–ª—å');

            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (/—Ñ–ª–∞–Ω—Ü/i.test(text)) params.connections.push('—Ñ–ª–∞–Ω—Ü–µ–≤–æ–µ');
            if (/–º—É—Ñ—Ç–æ–≤/i.test(text)) params.connections.push('–º—É—Ñ—Ç–æ–≤–æ–µ');
            if (/—Ä–µ–∑—å–±–æ–≤/i.test(text)) params.connections.push('—Ä–µ–∑—å–±–æ–≤–æ–µ');

            return params;
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        function compareTechnicalParams(queryParams, titleParams) {
            const compatibility = {
                score: 0,
                maxScore: 0,
                details: []
            };

            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∏–∞–º–µ—Ç—Ä–æ–≤ (–≤–µ—Å: 3 –±–∞–ª–ª–∞)
            if (queryParams.diameters.length > 0) {
                compatibility.maxScore += 3;
                const diameterMatch = queryParams.diameters.some(qd => 
                    titleParams.diameters.some(td => Math.abs(qd - td) <= 5) // ¬±5–º–º –¥–æ–ø—É—Å–∫
                );
                if (diameterMatch) {
                    compatibility.score += 3;
                    compatibility.details.push(`‚úÖ –î–∏–∞–º–µ—Ç—Ä: ${queryParams.diameters.join(', ')} ‚âà ${titleParams.diameters.join(', ')}`);
                } else if (titleParams.diameters.length > 0) {
                    compatibility.details.push(`‚ùå –î–∏–∞–º–µ—Ç—Ä: ${queryParams.diameters.join(', ')} ‚â† ${titleParams.diameters.join(', ')}`);
                }
            }

            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏–π (–≤–µ—Å: 2 –±–∞–ª–ª–∞)
            if (queryParams.pressures.length > 0) {
                compatibility.maxScore += 2;
                const pressureMatch = queryParams.pressures.some(qp => 
                    titleParams.pressures.some(tp => qp === tp)
                );
                if (pressureMatch) {
                    compatibility.score += 2;
                    compatibility.details.push(`‚úÖ –î–∞–≤–ª–µ–Ω–∏–µ: ${queryParams.pressures.join(', ')} = ${titleParams.pressures.join(', ')}`);
                } else if (titleParams.pressures.length > 0) {
                    compatibility.details.push(`‚ùå –î–∞–≤–ª–µ–Ω–∏–µ: ${queryParams.pressures.join(', ')} ‚â† ${titleParams.pressures.join(', ')}`);
                }
            }

            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–≤–µ—Å: 2 –±–∞–ª–ª–∞)
            if (queryParams.materials.length > 0) {
                compatibility.maxScore += 2;
                const materialMatch = queryParams.materials.some(qm => 
                    titleParams.materials.includes(qm)
                );
                if (materialMatch) {
                    compatibility.score += 2;
                    compatibility.details.push(`‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª: —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (${queryParams.materials.join(', ')})`);
                } else if (titleParams.materials.length > 0) {
                    compatibility.details.push(`‚ùå –ú–∞—Ç–µ—Ä–∏–∞–ª: ${queryParams.materials.join(', ')} ‚â† ${titleParams.materials.join(', ')}`);
                }
            }

            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–≤–µ—Å: 1 –±–∞–ª–ª)
            if (queryParams.connections.length > 0) {
                compatibility.maxScore += 1;
                const connectionMatch = queryParams.connections.some(qc => 
                    titleParams.connections.includes(qc)
                );
                if (connectionMatch) {
                    compatibility.score += 1;
                    compatibility.details.push(`‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (${queryParams.connections.join(', ')})`);
                } else if (titleParams.connections.length > 0) {
                    compatibility.details.push(`‚ùå –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${queryParams.connections.join(', ')} ‚â† ${titleParams.connections.join(', ')}`);
                }
            }

            return compatibility;
        }

        // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–∞–¥–≤–∏–∂–µ–∫
        function analyzeValveRelevance(query, title, pageType) {
            const queryLower = query.toLowerCase();
            const titleLower = title.toLowerCase();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–ª–æ–≤–∞ "–∑–∞–¥–≤–∏–∂–∫–∞" –≤ –∑–∞–ø—Ä–æ—Å–µ –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            const hasValveInQuery = /–∑–∞–¥–≤–∏–∂–∫/i.test(query);
            const hasValveInTitle = /–∑–∞–¥–≤–∏–∂–∫/i.test(title);
            
            if (!hasValveInQuery && !hasValveInTitle) {
                return { relevant: false, reason: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "–∑–∞–¥–≤–∏–∂–∫–∞"' };
            }
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–¥—ã (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            const codeComparison = compareValveCodes(query, title);
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const queryParams = extractTechnicalParams(query);
            const titleParams = extractTechnicalParams(title);
            const paramCompatibility = compareTechnicalParams(queryParams, titleParams);
            
            // 3. –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è
            if (codeComparison.match) {
                // –ï—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∫–æ–¥–æ–≤ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
                if (paramCompatibility.maxScore > 0 && paramCompatibility.score === paramCompatibility.maxScore) {
                    return { 
                        relevant: true, 
                        reason: `–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: –∫–æ–¥—ã + –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (${paramCompatibility.score}/${paramCompatibility.maxScore})`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                } else {
                    return { 
                        relevant: true, 
                        reason: `–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∫–æ–¥–æ–≤: ${codeComparison.details}`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                }
            }
            
            // 4. –ï—Å–ª–∏ –∫–æ–¥–æ–≤ –Ω–µ—Ç, –æ—Ü–µ–Ω–∏–≤–∞–µ–º –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
            if (paramCompatibility.maxScore > 0) {
                const compatibilityPercent = (paramCompatibility.score / paramCompatibility.maxScore) * 100;
                
                if (compatibilityPercent >= 80) {
                    return { 
                        relevant: true, 
                        reason: `–í—ã—Å–æ–∫–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (${paramCompatibility.score}/${paramCompatibility.maxScore})`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                } else if (compatibilityPercent >= 50) {
                    return { 
                        relevant: true, 
                        reason: `–ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (${paramCompatibility.score}/${paramCompatibility.maxScore})`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                } else {
                    return { 
                        relevant: false, 
                        reason: `–ù–∏–∑–∫–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (${paramCompatibility.score}/${paramCompatibility.maxScore})`,
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                }
            }
            
            // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –∞—Ä–º–∞—Ç—É—Ä—ã
            const queryInfo = extractInfo(query);
            const titleInfo = extractInfo(title);
            
            if (queryInfo.types.length > 0 && titleInfo.types.length > 0) {
                if (areTypesCompatible(queryInfo.types, titleInfo.types)) {
                    return { 
                        relevant: true, 
                        reason: '–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –∑–∞–¥–≤–∏–∂–µ–∫',
                        codeDetails: codeComparison,
                        paramDetails: paramCompatibility
                    };
                }
            }
            
            // 6. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ - —Ç–æ–ª—å–∫–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–¥–≤–∏–∂–∫–∏
            if (hasValveInQuery && hasValveInTitle) {
                return { 
                    relevant: true, 
                    reason: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–¥–≤–∏–∂–∫–∏ –±–µ–∑ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤',
                    codeDetails: codeComparison,
                    paramDetails: paramCompatibility
                };
            }
            
            return { 
                relevant: false, 
                reason: `–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: ${codeComparison.details}`,
                codeDetails: codeComparison,
                paramDetails: paramCompatibility
            };
        }

        function extractInfo(text) {
            const normalized = text.toLowerCase().replace(/[^\w–∞-—è]/g, ' ').replace(/\s+/g, ' ').trim();
            let foundTypes = [];
            
            for (let [code, expansion] of Object.entries(TECHNICAL_ABBREVIATIONS)) {
                if (normalized.includes(code)) {
                    foundTypes.push(...expansion.split(' '));
                }
            }
            
            if (currentConfig.productTypes) {
                for (let type of currentConfig.productTypes) {
                    if (normalized.includes(type)) {
                        foundTypes.push(type);
                    }
                }
            }
            
            return { types: [...new Set(foundTypes)] };
        }

        function areTypesCompatible(queryTypes, titleTypes) {
            if (!queryTypes.length || !titleTypes.length) return false;
            
            for (let qType of queryTypes) {
                if (titleTypes.includes(qType)) return true;
            }
            
            if (currentConfig.synonymGroups) {
                for (let group of currentConfig.synonymGroups) {
                    let queryHas = queryTypes.some(t => group.includes(t));
                    let titleHas = titleTypes.some(t => group.includes(t));
                    if (queryHas && titleHas) return true;
                }
            }
            
            return false;
        }

        function calculateOverallStats(results) {
            const productRelevant = results.products.filter(item => item.relevance.relevant).length;
            const listingRelevant = results.listings.filter(item => item.relevance.relevant).length;
            
            const weightedTotal = results.products.length * 1.0 + results.listings.length * 0.5;
            const weightedRelevant = productRelevant * 1.0 + listingRelevant * 0.5;
            const overallPercentage = weightedTotal > 0 ? (weightedRelevant / weightedTotal * 100).toFixed(1) : 0;

            return {
                total: results.total,
                products: results.products.length,
                listings: results.listings.length,
                overallPercentage: overallPercentage
            };
        }

        function calculateStats(pageData) {
            if (!pageData || !Array.isArray(pageData)) {
                return { total: 0, relevant: 0, irrelevant: 0, percentage: 0, problems: {} };
            }

            const total = pageData.length;
            const relevant = pageData.filter(item => item.relevance && item.relevance.relevant).length;
            const percentage = total > 0 ? (relevant / total * 100).toFixed(1) : 0;
            
            const problems = {};
            pageData.filter(item => item.relevance && !item.relevance.relevant).forEach(item => {
                const reason = item.relevance.reason || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞';
                problems[reason] = (problems[reason] || 0) + 1;
            });

            return { total, relevant, irrelevant: total - relevant, percentage, problems };
        }

        function displayResults(results) {
            try {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';

                const productStats = calculateStats(results.products);
                const listingStats = calculateStats(results.listings);
                const overallStats = calculateOverallStats(results);

                displayOverallStats(overallStats);
                displayComparisonTable(productStats, listingStats);
                displayCharacteristicsImportance(results.characteristics);
                displayTabContent(results, productStats, listingStats);

                showMessage('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
            } catch (error) {
                console.error('Error in displayResults:', error);
                showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${error.message}`, 'error');
            }
        }

        function displayOverallStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card excellent">
                    <span class="stat-value">${stats.total}</span>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                </div>
                <div class="stat-card good">
                    <span class="stat-value">${stats.products}</span>
                    <div class="stat-label">–¢–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</div>
                </div>
                <div class="stat-card satisfactory">
                    <span class="stat-value">${stats.listings}</span>
                    <div class="stat-label">–°—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∏–Ω–≥–∞</div>
                </div>
                <div class="stat-card poor">
                    <span class="stat-value">${stats.overallPercentage}%</span>
                    <div class="stat-label">–û–±—â–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å</div>
                </div>
            `;

            const qualityRating = document.getElementById('qualityRating');
            const percentage = parseFloat(stats.overallPercentage);
            let qualityClass, qualityText;
            
            if (percentage >= 90) {
                qualityClass = 'quality-excellent';
                qualityText = 'üü¢ –û–¢–õ–ò–ß–ù–û';
            } else if (percentage >= 80) {
                qualityClass = 'quality-good';
                qualityText = 'üü° –•–û–†–û–®–û';
            } else if (percentage >= 70) {
                qualityClass = 'quality-satisfactory';
                qualityText = 'üü† –£–î–û–í–õ–ï–¢–í–û–†–ò–¢–ï–õ–¨–ù–û';
            } else {
                qualityClass = 'quality-poor';
                qualityText = 'üî¥ –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø';
            }
            
            qualityRating.className = `quality-rating ${qualityClass}`;
            qualityRating.innerHTML = `${qualityText}<br><span style="font-size: 1.2rem;">–û–±—â–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${stats.overallPercentage}%</span>`;
        }

        function displayComparisonTable(productStats, listingStats) {
            const comparisonBody = document.getElementById('comparisonBody');
            
            const getTopProblems = (problems) => {
                if (!problems || typeof problems !== 'object') return '–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º';
                const sorted = Object.entries(problems).sort((a, b) => b[1] - a[1]);
                return sorted.slice(0, 2).map(([problem, count]) => `${problem} (${count})`).join(', ') || '–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º';
            };

            comparisonBody.innerHTML = `
                <tr>
                    <td><strong>–¢–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</strong></td>
                    <td>${productStats.total}</td>
                    <td><span style="color: ${productStats.percentage >= 80 ? '#38a169' : '#e53e3e'}">${productStats.percentage}%</span></td>
                    <td>${getTopProblems(productStats.problems)}</td>
                </tr>
                <tr>
                    <td><strong>–°—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∏–Ω–≥–∞</strong></td>
                    <td>${listingStats.total}</td>
                    <td><span style="color: ${listingStats.percentage >= 70 ? '#38a169' : '#e53e3e'}">${listingStats.percentage}%</span></td>
                    <td>${getTopProblems(listingStats.problems)}</td>
                </tr>
            `;
        }

        function displayCharacteristicsImportance(characteristics) {
            const characteristicsGrid = document.getElementById('characteristicsGrid');
            
            const filteredChars = Object.entries(characteristics)
                .filter(([key, data]) => data.percentage >= 1)
                .sort((a, b) => b[1].percentage - a[1].percentage)
                .slice(0, 12);

            if (filteredChars.length === 0) {
                characteristicsGrid.innerHTML = '<p style="text-align: center; opacity: 0.7;">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            characteristicsGrid.innerHTML = filteredChars.map(([key, data]) => `
                <div class="characteristic-item">
                    <span class="characteristic-percentage">${data.percentage}%</span>
                    <div class="characteristic-label">${data.name}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">${data.count}/${data.total}</div>
                </div>
            `).join('');
        }

        // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ —Å –ø–æ–ª–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        function displayTabContent(results, productStats, listingStats) {
            const productsContent = document.getElementById('products-content');
            const productExamples = getExamples(results.products, 5);
            
            productsContent.innerHTML = `
                <h3 class="section-title">‚úÖ –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π (${productExamples.good.length})</h3>
                ${productExamples.good.map(example => `
                    <div class="example-item good">
                        <div class="query"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ${example.query}</div>
                        <div class="title"><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${example.title}</div>
                        <div class="reason" style="color: #38a169;"><strong>‚úÖ –ü—Ä–∏—á–∏–Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏:</strong> ${example.relevance.reason}</div>
                        ${example.relevance.codeDetails ? `
                            <div class="valve-code-match">
                                <strong>üîß –ê–Ω–∞–ª–∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∫–æ–¥–æ–≤:</strong> ${example.relevance.codeDetails.details}
                            </div>
                        ` : ''}
                        ${example.relevance.paramDetails && example.relevance.paramDetails.details.length > 0 ? `
                            <div class="valve-code-match" style="background: #f0f8ff; border-left-color: #4facfe;">
                                <strong>üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (${example.relevance.paramDetails.score}/${example.relevance.paramDetails.maxScore}):</strong><br>
                                ${example.relevance.paramDetails.details.join('<br>')}
                            </div>
                        ` : ''}
                        ${example.relevance.typeDetails && example.relevance.typeDetails.details.length > 0 ? `
                            <div class="valve-code-match" style="background: #f0fff0; border-left-color: #38a169;">
                                <strong>üîß –¢–∏–ø—ã –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (${example.relevance.typeDetails.score}/${example.relevance.typeDetails.maxScore}):</strong><br>
                                ${example.relevance.typeDetails.details.join('<br>')}
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
                
                <h3 class="section-title">‚ùå –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (${productExamples.bad.length})</h3>
                ${productExamples.bad.map(example => `
                    <div class="example-item bad">
                        <div class="query"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ${example.query}</div>
                        <div class="title"><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${example.title}</div>
                        <div class="reason"><strong>‚ùå –ü—Ä–æ–±–ª–µ–º–∞:</strong> ${example.relevance.reason}</div>
                        ${example.relevance.codeDetails ? `
                            <div style="font-size: 0.85rem; margin-top: 8px; color: #666;">
                                <strong>üîß –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–æ–≤:</strong> ${example.relevance.codeDetails.details}
                            </div>
                        ` : ''}
                        ${example.relevance.paramDetails && example.relevance.paramDetails.details.length > 0 ? `
                            <div style="font-size: 0.85rem; margin-top: 8px; color: #666;">
                                <strong>üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (${example.relevance.paramDetails.score}/${example.relevance.paramDetails.maxScore}):</strong><br>
                                ${example.relevance.paramDetails.details.join('<br>')}
                            </div>
                        ` : ''}
                        ${example.relevance.typeDetails && example.relevance.typeDetails.details.length > 0 ? `
                            <div style="font-size: 0.85rem; margin-top: 8px; color: #666;">
                                <strong>üîß –¢–∏–ø—ã –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (${example.relevance.typeDetails.score}/${example.relevance.typeDetails.maxScore}):</strong><br>
                                ${example.relevance.typeDetails.details.join('<br>')}
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;

            const listingsContent = document.getElementById('listings-content');
            const listingExamples = getExamples(results.listings, 5);
            
            listingsContent.innerHTML = `
                <p style="margin-bottom: 20px; color: #666;">–°—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–æ–≤, –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –∫—Ä–∞—Ç–∫–∏—Ö –æ–ø–∏—Å–∞–Ω–∏–π (–≤–µ—Å 50%)</p>
                
                <h3 class="section-title">‚úÖ –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π (${listingExamples.good.length})</h3>
                ${listingExamples.good.map(example => `
                    <div class="example-item good">
                        <div class="query"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ${example.query}</div>
                        <div class="title"><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${example.title}</div>
                        <div class="reason" style="color: #38a169;"><strong>‚úÖ –ü—Ä–∏—á–∏–Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏:</strong> ${example.relevance.reason}</div>
                    </div>
                `).join('')}
                
                <h3 class="section-title">‚ùå –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (${listingExamples.bad.length})</h3>
                ${listingExamples.bad.map(example => `
                    <div class="example-item bad">
                        <div class="query"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ${example.query}</div>
                        <div class="title"><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${example.title}</div>
                        <div class="reason"><strong>‚ùå –ü—Ä–æ–±–ª–µ–º–∞:</strong> ${example.relevance.reason}</div>
                    </div>
                `).join('')}
            `;

            const problemsContent = document.getElementById('problems-content');
            const allProblems = { ...productStats.problems, ...listingStats.problems };
            
            problemsContent.innerHTML = `
                <h3 class="section-title">üîç –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –ø—Ä–æ–±–ª–µ–º</h3>
                ${Object.entries(allProblems).sort((a, b) => b[1] - a[1]).map(([problem, count]) => `
                    <div class="example-item">
                        <div class="query"><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> ${problem}</div>
                        <div class="title"><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É—á–∞–µ–≤:</strong> ${count}</div>
                        <div style="color: #666; margin-top: 10px;">
                            <strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> ${getProblemSolution(problem)}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getProblemSolution(problem) {
            const solutions = {
                '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ': '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —è–¥—Ä–æ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤',
                '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ': '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤',
                '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞': '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ landing page –∑–∞–ø—Ä–æ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
                '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "–∑–∞–¥–≤–∏–∂–∫–∞"': '–î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Ä–º–∏–Ω "–∑–∞–¥–≤–∏–∂–∫–∞" –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–ª–∏ —É–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏',
                '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "–∫—Ä–∞–Ω"': '–î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Ä–º–∏–Ω "–∫—Ä–∞–Ω" –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–ª–∏ —É–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏',
                '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∫–æ–¥–æ–≤': '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∫–æ–¥–æ–≤ –∑–∞–¥–≤–∏–∂–µ–∫ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –ì–û–°–¢',
                '–ù–∏–∑–∫–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤': '–£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ –¥–∏–∞–º–µ—Ç—Ä–æ–≤, –¥–∞–≤–ª–µ–Ω–∏–π –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–æ–º –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º',
                '–ù–∏–∑–∫–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ': '–£–ª—É—á—à–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏ —Ç–∏–ø–æ–≤ –∞—Ä–º–∞—Ç—É—Ä—ã',
                '–ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ': '–î–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏',
                '–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ': '–î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–î–£, –†–£, –º–∞—Ç–µ—Ä–∏–∞–ª, —Ç–∏–ø) –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏',
                '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è': '–î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤ –∑–∞–ø—Ä–æ—Å—ã –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏'
            };
            return solutions[problem] || '–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑';
        }

        function getExamples(data, limit) {
            if (!data || !Array.isArray(data)) {
                return { good: [], bad: [] };
            }

            const good = data.filter(item => item.relevance && item.relevance.relevant).slice(0, limit);
            const bad = data.filter(item => item.relevance && !item.relevance.relevant).slice(0, limit);
            return { good, bad };
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        function exportToPdf() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('–ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${currentConfig.name}`, 20, 50);
                doc.text(`–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: ${new Date().toLocaleDateString('ru-RU')}`, 20, 60);
                
                if (currentConfig.useValveCodes) {
                    doc.text('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Ñ–∏–≥—É—Ä –∑–∞–¥–≤–∏–∂–µ–∫', 20, 70);
                }
                
                const qualityElement = document.getElementById('qualityRating');
                if (qualityElement) {
                    const qualityText = qualityElement.textContent.replace(/\s+/g, ' ').trim();
                    doc.text(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${qualityText}`, 20, 90);
                }
                
                doc.save(`relevance_analysis_${currentConfig.name.toLowerCase()}_${new Date().toISOString().split('T')[0]}.pdf`);
                showMessage('PDF-–æ—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
